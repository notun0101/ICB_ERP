@model SalesInvoiceViewModel
@{
    ViewData["Title"] = "Sales Invoice";
}

@section Style{
    <link href="~/printJs/print.min.css" rel="stylesheet" type="text/css" />
    <style>
        .redStar {
            color: red;
        }
    </style>
}

<div class="card" style="width: 100%;">
    <div class="card-body">
        <div class="row">
            <div class="col-6">
                <h5 class="card-title" style="color: black">Point Of Sales</h5>
            </div>
            @*<div class="col-6">
                <a href="#" id="TSale" onclick="showtodaysale()" style="background-color:#2ecc71;float:right;height: 35px;" class="btn btn-info btn-sm">Today's Sale</a>&nbsp;
                <a href="#" id="TSaleDraft" onclick="showtodaysaleDraft()" style="background-color:#3498db;float:right;height: 35px;" class="btn btn-info btn-sm">Draft Billing</a>&nbsp;
                <a href="/POS/Pos/SaleReturnInvoice" style="background-color:#fa8019;float:right;height: 35px;" class="btn btn-info btn-sm">Return Bill</a>&nbsp;
                <a href="#" id="TSaleP" onclick="showtodaysale()" style="background-color:#e74c3c;float:right;height: 35px;" class="btn btn-info btn-sm">Re-Print</a>&nbsp;
                <a href="/POS/Pos/POSInvoiceList" style="background-color:#757575;float:right;height: 35px;" class="btn btn-info btn-sm">Back To List</a>
            </div>*@
        </div>
        <hr>
        <div class="container">

            <form method="post" id="frmPOS" data-parsley-validate="parsley">

                <div asp-validation-summary="All" class="text-danger"></div>

                <div class="form-group row">
                    <label for="salesInvoiceNo" class="col-sm-2 col-form-label">Sales Invoice No</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="salesInvoiceNo" id="salesInvoiceNo" value="@Model.salesInvoiceMaster.invoiceNumber" readonly>
                        <input type="hidden" name="masterId" id="masterId" value="0" />
                    </div>
                    <label for="invoiceDate" class="col-sm-2 col-form-label text-left">Invoice Date</label>
                    <div class="col-sm-4 input-group">
                        <input name="invoiceDate" id="invoiceDate" class="form-control input-group-sm" value="" />
                        <div class="input-group-prepend">
                            <label for="invoiceDate" class="fas fa-calendar-alt form-control input-group-sm input-group-text bg-white"></label>
                        </div>
                    </div>
                </div>

                <div class="form-group row">

                    <label for="customerMobile" class="col-sm-2 col-form-label text-left">Customer mobile<span class="redStar">*</span></label>
                    <div class="col-sm-4 input-group">
                        <input name="customerMobile" id="customerMobile" class="form-control input-group-sm" value="@Model.salesInvoiceMaster?.relSupplierCustomerResourse?.resource?.mobile" data-parsley-required="true" data-parsley-trigger="keyup" />
                    </div>

                    <label for="customerName" class="col-sm-2 col-form-label">Customer Name</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="customerName" id="customerName" value="@Model.salesInvoiceMaster?.relSupplierCustomerResourse?.Leads?.leadName">
                        <input type="hidden" name="customerId" id="customerId" value="@Model.salesInvoiceMaster?.relSupplierCustomerResourseId" />
                    </div>
                </div>
                <div class="form-group row">
                    <label for="address" class="col-sm-2 col-form-label text-left">Customer Address</label>
                    <div class="col-sm-4 input-group">
                        <textarea type="text" class="form-control" name="address" id="address" value="@Model.salesInvoiceMaster?.shippingAddress"></textarea>
                    </div>

                    <label for="isMember" class="col-sm-2 col-form-label text-left">Is Member?</label>
                    <div class="col-sm-1 input-group">
                        <input type="checkbox" name="isMember" id="isMember" style="margin-left:-30px;" class="form-check-input" value="1" />
                    </div>

                    <label for="cardNo" style="display:none" id="forCard" class="col-sm-2 col-form-label text-left">Member Ship No</label>
                    <div class="col-sm-1 input-group" id="forCardDiv" style="display:none">
                        <input type="text" name="cardNo" id="cardNo" style="width:105px;margin-left:-50px;" class="form-control input-group-sm" value="" />
                    </div>
                </div>
                <div class="form-group row">
                    <label for="baleboy" class="col-sm-2 col-form-label text-left">Bale Boy</label>
                    <div class="col-sm-4 input-group">
                        <input name="baleboy" id="baleboy" class="form-control input-group-sm" value="@Model.salesInvoiceMaster?.alternateMobile" />
                    </div>                   
                </div>
                <hr />
                <div class="form-group row">
                    <label for="itemName" class="col-sm-2 col-form-label">Item Name <span class="redStar">*</span></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="itemName" id="itemName">
                        <input type="hidden" name="itemId" id="itemId" value="0" />
                    </div>
                    <label for="itemSpecification" class="col-sm-2 col-form-label">Item Specification <span class="redStar">*</span></label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="itemSpecification" id="itemSpecification">
                        <input type="hidden" name="itemSpecificationId" id="itemSpecificationId" value="0" />
                        <input type="hidden" name="itemSpecificationIdOriginal" id="itemSpecificationIdOriginal" value="0" />
                        <input type="hidden" name="barcodeorg" id="barcodeorg" value="" />
                    </div>
                </div>

                <div class="form-group row">
                    <label for="price" class="col-sm-2 col-form-label">Price (Taka)</label>
                    <div class="col-sm-2">
                        <input type="number" class="form-control" name="price" id="price" readonly>
                    </div>
                    <label for="onHand" class="col-sm-1 col-form-label">OnHand</label>
                    <div class="col-sm-2">
                        <input type="number" class="form-control" name="onHand" id="onHand" readonly>
                    </div>

                    <label for="quantity" class="col-sm-1 col-form-label">Quantity</label>
                    <div class="col-sm-2">
                        <input type="number" min="1" class="form-control" name="quantity" id="quantity">
                    </div>
                    <label for="unit" class="col-sm-1 col-form-label">Unit</label>
                    <div class="col-sm-1">
                        <input type="text" class="form-control" name="unit" id="unit" readonly>
                    </div>
                    <label style="margin-top: 5px;" for="discount" class="col-sm-2 col-form-label">Disc.(%)</label>
                    <div class="col-sm-2" style="margin-top: 5px;">
                        <input type="number" class="form-control" name="discount" id="discount" readonly>
                    </div>
                    <label for="vat" class="col-sm-1 col-form-label">VAT (%)</label>
                    <div class="col-sm-2" style="margin-top: 5px;">
                        <input type="number" class="form-control" name="vat" id="vat" readonly>
                    </div>
                </div>

                <hr>

                <div class="form-group row">
                    <div class="col-md-12">
                        <button type="button" onclick="AdditemDetails()" value="Add" title="Add" class="btn btn-success" style="float:right;"><i class="fas fa-plus fa-w-1"></i></button>
                    </div>
                </div>

                <hr>

                <div class="form-group row">
                    <input type="hidden" id="rowCount" name="rowCount" value="0" />
                    <div class="col-12">
                        <table class="table table-bordered table-striped" id="tblitemDetails" data-parsley-required="true">
                            <thead style="width:100%;background-color:lightgray;">
                                <tr>
                                    <th width="11%">Item</th>
                                    <th width="15%">Item Spac.</th>
                                    <th width="10%">Price</th>
                                    <th width="10%">On Hand</th>
                                    <th width="10%">Qty</th>
                                    <th width="7%">Disc.(%)</th>
                                    <th width="6%">VAT(%)</th>
                                    <th width="10%">Total</th>
                                    <th width="4%">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-sm-8">&nbsp;</div>
                    <label for="grossTotal" class="col-sm-2 col-form-label" style="text-align:right;">Gross Total </label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" name="grossTotal" id="grossTotal" value="@Model.salesInvoiceMaster.totalAmount?.ToString("0.00")" readonly style="text-align:right;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-sm-8">&nbsp;</div>
                    <label for="grossDiscount" class="col-sm-2 col-form-label" style="text-align:right;">Discount (%) </label>
                    <div class="col-sm-2">
                        <input type="number" class="form-control" max="10" min="0" onclick="CalculationNetTotal()" value="@Model.salesInvoiceMaster.DiscountOnTotal?.ToString("0.00")" name="grossDiscount" id="grossDiscount" style="text-align:right;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-sm-8">&nbsp;</div>
                    <label for="grossVAT" class="col-sm-2 col-form-label" style="text-align:right;">VAT (%) </label>
                    <div class="col-sm-2">
                        <input type="number" class="form-control" max="100" onclick="CalculationNetTotal()" value="@Model.salesInvoiceMaster.VATOnTotal?.ToString("0.00")" name="grossVAT" id="grossVAT" style="text-align:right;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-sm-8">&nbsp;</div>
                    <label for="netTotal" class="col-sm-2 col-form-label" style="text-align:right;">Net Total </label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" name="netTotal" id="netTotal" value="@Model.salesInvoiceMaster.NetTotal?.ToString("0.00")" readonly style="text-align:right;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-sm-8">&nbsp;</div>
                    <label for="given" class="col-sm-2 col-form-label" style="text-align:right;"> Given Amount </label>
                    <div class="col-sm-2">
                        <input type="number" onclick="CanculateChange()" onkeyup="CanculateChange()" class="form-control" name="given" id="given" value="" style="text-align:right;">
                    </div>
                </div>

                <div class="form-group row">
                    <div class="col-sm-8">&nbsp;</div>
                    <label for="change" class="col-sm-2 col-form-label" style="text-align:right;"> Change </label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" name="change" id="change" value="" readonly style="text-align:right;">
                    </div>
                </div>


                <hr />
                @*<div class="form-group row">
            <label for="accountLedgerId" class="col-sm-2 col-form-label">Store Name</label>
            <div class="col-sm-10">
                <select class="form-control" name="storeId" id="storeId">

                    @foreach (var data in Model.storeAssigns.Where(x => x.store.Id == ViewBag.storeId))
                    {
                        <option value="@data.storeId">@data.store.storeName</option>
                    }
                </select>
            </div>
        </div>*@
                <div class="form-group row">
                    <label for="date" class="col-sm-2 col-form-label">Payment Mode <span class="redStar">*</span></label>
                    <div class="col-sm-10">
                        <select type="text" class="form-control" id="paymentModeId" name="paymentModeId">

                            @foreach (var data in Model.paymentModes)
                            {
                                <option value="@data.Id">@data.paymentModeName</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="date" class="col-sm-2 col-form-label"></label>
                    <div class="col-sm-10 row" id="divCashBank">
                        <div class="col-sm-6 row" id="cash">
                            <label class="col-sm-6 col-form-label">Cash Amount</label>
                            <input data-parsley-type="number" class="col-sm-6 form-control" id="cashAmount" value="" name="cashAmount">
                        </div>
                        <div class="col-sm-6 row" id="bank" style="display:none">

                            <label class="col-sm-6 col-form-label">Bank Amount</label>
                            <input data-parsley-type="number" class="col-sm-6 form-control" id="bankAmount" value="" name="bankAmount">
                        </div>

                    </div>
                    <div class="col-sm-10 row" id="divCard" style="display:none">
                        <div class="col-sm-4 row">
                            <label class="col-sm-6 col-form-label">Card Type</label>
                            <select id="cardTypeId" name="cardTypeId" class="col-sm-6 form-control">
                                @foreach (var data in Model.cardTypes)
                                {
                                    <option value="@data.Id">@data.CardTypeName</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-4 row">
                            <label class="col-sm-6 col-form-label">Card Amount</label>
                            <input data-parsley-type="number" class="col-sm-6 form-control" id="cardAmount" value="" name="cardAmount">
                        </div>
                        <div class="col-sm-4 row">
                            <label class="col-sm-5 col-form-label">Card Bank</label>
                            <select id="bankInfoId" name="bankInfoId" class="col-sm-7 form-control">
                                @foreach (var data in Model.bankInfos)
                                {
                                    <option value="@data.Id">@data.bankName</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-10 row" id="divMobileBanking" style="display:none">
                        <div class="col-sm-4 row">
                            <label class="col-sm-5 col-form-label">Banking Type</label>
                            <select id="mobileBankingTypeId" name="mobileBankingTypeId" class="col-sm-7 form-control">
                                @foreach (var data in Model.mobileBankingTypes)
                                {
                                    <option value="@data.Id">@data.walletTypeName</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-4 row">
                            <label class="col-sm-5 col-form-label">Mobile Amount</label>
                            <input data-parsley-type="number" class="col-sm-7 form-control" id="mobileAmount" value="" name="mobileAmount">
                        </div>
                        <div class="col-sm-4 row" style="float:right">
                            <label class="col-sm-5 col-form-label">Trx Number</label>
                            <input type="text" class="col-sm-7 form-control" id="trxNumber" value="" name="trxNumber" style="width:100%;">
                        </div>
                    </div>
                </div>

                <hr>
                <button type="submit" id="btnPOSSubmit" title="Final" class="btn btn-success btn-lg m-2" style="float:right;"><i class="fas fa-save"></i></button>
                <button type="button" onclick="Refresh()" title="Refresh" class="btn btn-danger btn-lg m-2" style="float:right;"><i class="fas fa-sync"></i></button>

            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="row" style="width:100%;">
                    <div class="col-3">
                        <img src="~/images/JasonLogo.png" style="height:66px; width:168px;" />
                    </div>
                    <div class="col-8">
                        <h3 class="modal-title text-center" id="exampleModalLabel" style="font-size: 20px;padding-top: 14px; color:black">Sales Information</h3>
                    </div>
                    <div class="col-1">
                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group row" style="padding-top:5px;margin-left:40px">
                    <label class="col-md-3 text-center" style="color: #333;padding-top:2px;">From</label>
                    <div class="col-md-9">
                        <input type="text" id="fromDate" class="form-control clsSalesDate" readonly style="display:inline-block" />
                    </div>
                </div>
                <div class="form-group row" style="padding-top:5px;">
                    <label class="col-md-3 text-right" style="color: #333;padding-top:2px;">To</label>
                    <div class="col-md-9">
                        <input type="text" id="toDate" class="form-control clsSalesDate" readonly style="display:inline-block" />
                    </div>
                </div>
                <div class="form-group row" style="padding-top:5px;">
                    <label class="col-md-3 text-right" style="color: #333;padding-top:2px;">  </label>
                    <div class="col-md-9">
                        <a href="#" id="TSale" onclick="showsale()" style="background-color:grey;float:right;height: 35px;" class="btn btn-info btn-sm">Load</a>&nbsp;
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-striped" style="line-height:.9" id="tblSalesModal">
                    <thead>
                        <tr>
                            <th width="5%">SL#</th>
                            <th width="15%">Invoice No</th>
                            <th width="15%">Invoice Date</th>
                            <th width="10%">Customer</th>
                            <th width="10%">Gross Total</th>
                            <th width="10%">Discount(%)</th>
                            <th width="10%">VAT(%)</th>
                            <th width="15%">Net Total</th>
                            <th width="10%">Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="registerModalDraft" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="row" style="width:100%;">
                    <div class="col-3">
                        <img src="~/images/JasonLogo.png" style="height:66px; width:168px;" />
                    </div>
                    <div class="col-8">
                        <h3 class="modal-title text-center" id="exampleModalLabel" style="font-size: 20px;padding-top: 14px; color:black">Draft Sales Information</h3>
                    </div>
                    <div class="col-1">
                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group row" style="padding-top:5px;margin-left:40px">
                    <label class="col-md-3 text-center" style="color: #333;padding-top:2px;">From</label>
                    <div class="col-md-9">
                        <input type="text" id="fromDateDraft" class="form-control clsSalesDate" readonly style="display:inline-block" />
                    </div>
                </div>
                <div class="form-group row" style="padding-top:5px;">
                    <label class="col-md-3 text-right" style="color: #333;padding-top:2px;">To</label>
                    <div class="col-md-9">
                        <input type="text" id="toDateDraft" class="form-control clsSalesDate" readonly style="display:inline-block" />
                    </div>
                </div>
                <div class="form-group row" style="padding-top:5px;">
                    <label class="col-md-3 text-right" style="color: #333;padding-top:2px;">  </label>
                    <div class="col-md-9">
                        <a href="#" id="TSale" onclick="showsaleDraft()" style="background-color:grey;float:right;height: 35px;" class="btn btn-info btn-sm">Load</a>&nbsp;
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-striped" style="line-height:.9" id="tblSalesModalDraft">
                    <thead>
                        <tr>
                            <th width="5%">SL#</th>
                            <th width="15%">Invoice No</th>
                            <th width="15%">Invoice Date</th>
                            <th width="10%">Customer</th>
                            <th width="10%">Gross Total</th>
                            <th width="10%">Discount(%)</th>
                            <th width="10%">VAT(%)</th>
                            <th width="15%">Net Total</th>
                            <th width="10%">Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div style="display:none">
    <iframe id="myFrame"
            frameborder="0" style="border:0;"
            width="300" height="300"></iframe>
</div>
@section Scripts{

    <script src="~/printJs/print.min.js" type="text/javascript"></script>

    <script>
        function addCommas(x) {
            var parts = x.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
        }
        function GetSalesData(response) {
            console.log(response);
            var i = 0;
            $("#tblSalesModal").DataTable().destroy();

            $("#tblSalesModal tbody>tr").remove();
            var totalvat = 0;
            var totalgross = 0;
            var totaldiscount = 0;
            var totalnet = 0;
            var dtTable1 = $("#tblSalesModal");
            var tableBody1 = dtTable1.find('tbody');
            $.each(response, function (key, value) {

                if (value.grossTotal == null)
                {

                    value.grossTotal = 0;

                }
                if (value.grossDiscount == null) {

                    value.grossDiscount = 0;
                }
                if (value.grossVAT == null) {

                    value.grossVAT = 0;
                }
                if (value.netAmount == null) {

                    value.netAmount = 0;
                }
                totalvat = totalvat + value.grossVAT;
                totalgross = totalgross + value.grossTotal;
                totaldiscount = totaldiscount + value.grossDiscount;
                totalnet = totalnet + value.netAmount;
                i++;

                var trHtml1 = '<tr><td>' + i + '</td><td>' + value.invoiceNumber + '</td><td>' + value.invoiceDate + '</td><td>' + value.customerName + '</td><td style="text-align:right;">' + addCommas(value.grossTotal) + '</td><td style="text-align:right;">' + addCommas(value.grossDiscount) + '</td><td style="text-align:right;">' + addCommas(value.grossVAT) + '</td><td style="text-align:right;">' + addCommas(value.netAmount) + '</td><td><a href="/POS/Pos/POSInvoicePDFAction?id=' + value.salesId+'" target="_blank" title="Invoice Print"><i class="fa fa-eye"></i></a></td></tr>';
                tableBody1.append(trHtml1);

            });
            var trHtml1 = '<tr><td>Total</td><td></td><td></td><td></td><td style="text-align:right;">' + addCommas(totalgross) + '</td><td style="text-align:right;">' + addCommas(totaldiscount) + '</td><td style="text-align:right;">' + addCommas(totalvat) + '</td><td style="text-align:right;">' + addCommas(totalnet) + '</td><td></td></tr>';
            tableBody1.append(trHtml1);
            $("#tblSalesModal").DataTable();
            $("#registerModal").modal("show");



        }
        function GetSalesDataDraft(response) {
            console.log(response);
            var i = 0;
            $("#tblSalesModalDraft").DataTable().destroy();

            $("#tblSalesModalDraft tbody>tr").remove();
            var totalvat = 0;
            var totalgross = 0;
            var totaldiscount = 0;
            var totalnet = 0;
            var dtTable1 = $("#tblSalesModalDraft");
            var tableBody1 = dtTable1.find('tbody');
            $.each(response, function (key, value) {
                if (value.totalAmount == null) {

                    value.totalAmount = 0;

                }
                if (value.DiscountOnTotal == null) {

                    value.DiscountOnTotal = 0;
                }
                if (value.VATOnTotal == null) {

                    value.VATOnTotal = 0;
                }
                if (value.NetTotal == null) {

                    value.NetTotal = 0;
                }
                totalvat = totalvat + value.VATOnTotal;
                totalgross = totalgross + value.totalAmount;
                totaldiscount = totaldiscount + value.DiscountOnTotal;
                totalnet = totalnet + value.NetTotal;
                i++;

                var trHtml1 = '<tr><td>' + i + '</td><td>' + value.invoiceNumber + '</td><td>' + value.invoiceDate + '</td><td>' + value.posCustomer.name + '</td><td style="text-align:right;">' + addCommas(value.totalAmount) + '</td><td style="text-align:right;">' + addCommas(value.DiscountOnTotal) + '</td><td style="text-align:right;">' + addCommas(value.VATOnTotal) + '</td><td style="text-align:right;">' + addCommas(value.NetTotal) + '</td><td><a href="/POS/Pos/Index?id=' + value.Id + '" title="Invoice Edit"><i class="fa fa-edit"></i></a></td></tr>';
                tableBody1.append(trHtml1);
            });
            var trHtml1 = '<tr><td>Total</td><td></td><td></td><td></td><td style="text-align:right;">' + addCommas(totalgross) + '</td><td style="text-align:right;">' + addCommas(totaldiscount) + '</td><td style="text-align:right;">' + addCommas(totalvat) + '</td><td style="text-align:right;">' + addCommas(totalnet) + '</td><td></td></tr>';
            tableBody1.append(trHtml1);
            $("#tblSalesModalDraft").DataTable();
            $("#registerModalDraft").modal("show");



        }
        function showtodaysale() {

                Common.Ajax('GET', '/global/api/DailySalesInformationbyDate/', [], 'json', GetSalesData);

        };
        function showsale() {

            Common.Ajax('GET', '/global/api/DailySalesInformationbyDateRange/' + $("#fromDate").val() + '/' + $("#toDate").val(), [], 'json', GetSalesData);

        };
        function showtodaysaleDraft() {

            Common.Ajax('GET', '/global/api/DailySalesInformationbyDateDraft/', [], 'json', GetSalesDataDraft);

        };
        function showsaleDraft() {

            Common.Ajax('GET', '/global/api/DailySalesInformationbyDateRangeDraft/' + $("#fromDateDraft").val() + '/' + $("#toDateDraft").val(), [], 'json', GetSalesDataDraft);

        };
        $(document).ready(function () {
            $("#invoiceDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#tblSalesModal").dataTable();
            $("#tblSalesModalDraft").dataTable();
            $("#paymentDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#fromDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#toDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#fromDateDraft").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#toDateDraft").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());

            if ($("#salesInvoiceNo").val() == "") {
                $("#salesInvoiceNo").val('@ViewBag.SaleNo');
            }

            $("#invoiceDate").val('@DateTime.Now.ToString("dd-MMM-yyyy")');

            if (@Model.masterId > 0 || @Model.masterId == null) {
                $("#masterId").val('@Model.masterId');
                $("#invoiceDate").val('@Model.salesInvoiceMaster.invoiceDate?.ToString("dd-MMM-yyyy")');
            }

            $("#sidebarToggle").trigger('click');

            //Common.Ajax('GET', '/global/api/GetPosCustomer', [], 'json', ajaxAllCustomer);
            Common.Ajax('GET', '/global/api/GetCustomerInfoByRoleId', [], 'json', ajaxAllCustomer);
            Common.Ajax('GET', '/global/api/getAllActiveItemFromItemPrice', [], 'json', ajaxAllActiveItem);
            //Common.Ajax('GET', '/global/api/GetPosRepInvoiceDetailByMasterId/' + @Model.masterId, [], 'json', ajaxitemDetailsForEdit);
            Common.Ajax('GET', '/global/api/getAllOSalesInvoiceDetailByMasterId/' + @Model.masterId, [], 'json', ajaxitemDetailsForEdit);

            $("#grossDiscount").keyup(function () {
                CalculationNetTotal();
            });
            $("#grossVAT").keyup(function () {
                CalculationNetTotal();
            });

            $('#itemName').keydown(function (e) {
                if (e.keyCode == 13) {
                    event.preventDefault();
                    let barCode = $(this).val();

                    //Common.Ajax('GET', '/global/api/GetItemDetailsInfoByBarCode/' + barCode, [], 'json', AdditemDetailsByAuto);
                }
            })

            $('#isMember').on('change', function () {
                if ($('#isMember').is('checked'), true) {
                    $('#forCard').show();
                    $('#forCardDiv').show();
                }
            })

            $('#paymentModeId').on('change', function (e) {
                var val = $(this).val();
                var total = $('#netTotal').val();
                if (val == 1) {
                    $('#cash').show();
                    $('#bank').hide();
                    $('#divCashBank').show();
                    $('#divCard').hide();
                    $('#divMobileBanking').hide();
                    $('#cashAmount').val(total);
                }
                else if (val == 2) {
                    $('#bank').show();
                    $('#cash').hide();
                    $('#divCashBank').show();
                    $('#divCard').hide();
                    $('#divMobileBanking').hide();
                    $('#bankAmount').val(total);
                }
                else if(val == 3){
                    $('#bank').show();
                    $('#cash').show();
                    $('#divCashBank').show();
                    $('#divCard').hide();
                    $('#divMobileBanking').hide();
                    $('#bankAmount').val(total / 2);
                    $('#cashAmount').val(total / 2);
                }
                else if (val == 4) {
                    $('#divCashBank').hide();
                    $('#divCard').show();
                    $('#divMobileBanking').hide();
                    $('#cardAmount').val(total);
                }
                else if (val == 5) {
                    $('#divCashBank').hide();
                    $('#divCard').hide();
                    $('#divMobileBanking').show();
                    $('#mobileAmount').val(total);
                }
            });                        


            $("#btnPOSSubmit").click(function (e) {
                $("#btnPOSSubmit").attr('disabled', true);
                var rowCount = $('#tblitemDetails tbody>tr').length;
                let customerMobile = $('#customerMobile').val();
                let grossDiscount = $('#grossDiscount').val();
                if (customerMobile == '') {
                    alert("Please Entred Mobile No");
                    $("#btnPOSSubmit").attr('disabled', false);
                    return false;
                }
                else if (rowCount == 0) {
                    alert("Please Add Minimum 1 Item");
                    $("#btnPOSSubmit").attr('disabled', false);
                    return false;
                }
                else if (grossDiscount > @Model.discountRate) {
                    alert("Discount Must be Less then or equal " + @Model.discountRate+"%");
                    $("#btnPOSSubmit").attr('disabled', false);
                    return false;
                }

                e.preventDefault();

                var form = $("#frmPOS");
                $.ajax({
                    url: '@Url.Action("PosIndex", "SalesInvoice")',
                    data: form.serialize(),
                    type: 'POST',
                    success: function (records) {                      

                        printJS({ printable: "/pdf/" + records, type: 'pdf', showModal: true, onPrintDialogClose: printJobComplete });
                        $("#btnPOSSubmit").attr('disabled', false);
                       
                    }
                });
            });


        });
       

        function printJobComplete() {
            location.reload();
        }

        function fnGrandTotal(index) {
            var subtotal = 0;
            var onHand = $("#onHand" + index).val();
            var qnt = $("#quantity" + index).val();
            if (parseFloat(qnt) > parseFloat(onHand)) {
                alert("Sorry!! You Didn't Have Enough Stock.");
                $("#quantity" + index).val("1");
                return false;
            }

            let qty = parseFloat($("#quantity" + index).val()) ? parseFloat($("#quantity" + index).val()) : 0;
            let price = parseFloat($("#price" + index).val()) ? parseFloat($("#price" + index).val()) : 0;
            let discount = parseFloat($("#discount" + index).val()) ? parseFloat($("#discount" + index).val()) : 0;
            let vat = parseFloat($("#vat" + index).val()) ? parseFloat($("#vat" + index).val()) : 0;
            var totalAmount = (price * qty) - ((price * qty) * discount / 100.00) + ((price * qty) * vat / 100.00);
            subtotal = totalAmount;//price * qty;
            $("#tdSubTotal" + index).html(subtotal);
            $("#totalAmount" + index).val(subtotal);

            CalculateGrossTotal();


        }

        function ajaxAllActiveItem(response) {
            var GetInStockItemList = [];
            $.each(response, function (id, option) {
                var obj = new Object();
                obj.key = option.Id;
                obj.value = option.itemName;
                obj.itemCode = option.itemCode;
                GetInStockItemList[GetInStockItemList.length] = obj;
            });
            $('#itemName').autocomplete({
                source: GetInStockItemList,
                select: function (event, ui) {
                    $("#itemId").val(ui.item.key);
                   
                    Common.Ajax('GET', '/global/api/getAllPriceFixedItemSpacificationByItemId/' + ui.item.key, [], 'json', ajaxAllPriceFixedItemSpacification);

                    //Common.Ajax('GET', '/global/api/ItemSpec/' + ui.item.key, [], 'json', ajaxAllPriceFixedItemSpacification);
                }
            });
        }
        
        function ajaxAllPriceFixedItemSpacification(response) {
            console.log(response);
            var GetInStockItemSpacificationList = [];
            $.each(response, function (id, option) {
                var obj = new Object();
                obj.key = option.Id;
                obj.value = option.itemSpecificationName;
                obj.price = option.price;
                obj.VAT = option.VAT;
                obj.itemSpecificationId = option.itemSpecificationId;
                obj.discountPersent = option.discountPersent;
                obj.unitName = option.unitName;
                obj.barcode = option.barcode;
                GetInStockItemSpacificationList[GetInStockItemSpacificationList.length] = obj;
            });
            $('#itemSpecification').autocomplete({
                source: GetInStockItemSpacificationList,
                select: function (event, ui) {
                    $("#itemSpecificationId").val(ui.item.key);
                    $("#price").val(ui.item.price);
                    $("#discount").val(ui.item.discountPersent);
                    $("#vat").val(ui.item.VAT);
                    $("#unit").val(ui.item.unitName);
                    $("#itemSpecificationIdOriginal").val(ui.item.itemSpecificationId);
                    $("#barcodeorg").val(ui.item.barcode);


                    //Common.Ajax('GET', '/global/api/OnHanStockBySpecId/' + ui.item.itemSpecificationId, [], 'json', ajaxSetOnhand);
                }
            });
        }

        function ajaxSetOnhand(response) {
            $("#onHand").val(response);
        }

        function ajaxAllCustomer(response) {
            var GetInStockItemSpacificationList = [];
            $.each(response, function (id, option) {
                var obj = new Object();
                obj.key = option.relId;
                obj.name = option.customerName;
                obj.value = option.mobile;
                obj.address = option.address;
                obj.ismembership = option.ismembership;
                obj.cardNo = option.cardNo;
                GetInStockItemSpacificationList[GetInStockItemSpacificationList.length] = obj;
            });
            $('#customerMobile').autocomplete({
                source: GetInStockItemSpacificationList,
                select: function (event, ui) {
                    $("#customerId").val(ui.item.key);
                    $("#customerName").val(ui.item.name);
                    $("#address").val(ui.item.address);
                    $("#cardNo").val(ui.item.cardNo);
                    if (ui.item.ismembership == 1) {
                        $("#isMember").prop("checked", true);
                        $("#forCardDiv").show();
                        $("#forCard").show();
                        if ($("#cardNo").val() == "") {
                            swal('Warning', 'Enter Membership No!', 'warning');
                            return false;
                        }
                        //$("#cardNo").attr('readonly', true);
                    }
                    else
                    {
                        $("#isMember").prop("checked", false);
                        $("#forCardDiv").hide();
                        $("#forCard").hide();
                    }
                }
            });
        }

        function Refresh() {
            location.reload();
        }

        
        var index = 1;
        function AdditemDetails() {
            if ($("#itemSpecificationId").val() == "" || $("#itemSpecificationId").val() == "0") {
                alert("Plaese Select Valid Item Specification.");
                return false
            }
            if ($("#barcodeorg").val().startsWith("P")) {
            }
            else
            {
                if ($("#quantity").val() == '' || parseFloat($("#quantity").val()) > parseFloat($("#onHand").val()) || parseFloat($("#quantity").val()) <= 0) {
                    alert("Plaese Enter Valid Quantity.");
                    return false
                }
            }


            var itemName = $("#itemName").val();
            var itemSpecification = $("#itemSpecification").val();
            var itemSpecificationId = $("#itemSpecificationId").val();
            var itemSpecificationIdOriginal = $("#itemSpecificationIdOriginal").val();
            var price = parseFloat($("#price").val());
            var quantity = parseFloat($("#quantity").val());
            var barcode = $("#barcodeorg").val();
            var onHand = $("#onHand").val();

            var discount = parseFloat($("#discount").val()) ? parseFloat($("#discount").val()) : 0.00;
            var vat = parseFloat($("#vat").val()) ? parseFloat($("#vat").val()) : 0.00;

            var totalAmount = (price * quantity) - ((price * quantity) * discount / 100.00) + ((price * quantity) * vat / 100.00);

            var RowCount = $("#tblitemDetails tbody>tr").length;

            for (i = 1; i <= RowCount; i++) {
                var _itemSpecificationId = $("#itemPriceFixingId" + i).val();
                if (_itemSpecificationId == itemSpecificationId) {
                    alert('You have already added this Item!');
                    return false
                }
            }

            var dtTable = $("#tblitemDetails");
            var tableBody = dtTable.find('tbody');
            var trHtml = '<tr id=' + index + '>' +
                '<td>' + itemName + '</td>' +
                '<td>' + itemSpecification + '<input type="hidden" id="itemPriceFixingId' + index + '" name="itemPriceFixingId[]" class="clsitemSpecificationId" value="' + itemSpecificationId + '"/><input type="hidden" id="IdOriginal" name="IdOriginal[]" value="' + itemSpecificationIdOriginal + '"></td>' +
                '<td>' + price.toFixed(2) + '<input type="hidden" id="priceList' + index + '" name="priceList[]" class="clsprice" value="' + price + '"/><input type="hidden" id="barcode" name="barcode[]" class="clsbarcode" value="' + barcode + '"/></td>' +
                '<td>' + onHand + '<input type="hidden" id="onHand' + index + '" name="onHand" class="clsdiscount" value="' + onHand + '"/></td>' +
                '<td><input type="number" min="0" id="quantity' + index + '" onkeyup="fnGrandTotal(' + index + ')" onclick="fnGrandTotal(' + index + ')" name="tblQuantity[]" class="clsquantity text-right" value="' + quantity + '" style="width:100%;padding-right:2px;" /></td>' +
                '<td>' + discount + '<input type="hidden" id="discount' + index + '" name="discount" class="clsdiscount" value="' + discount + '"/></td>' +
                '<td>' + vat + '<input type="hidden" id="vat' + index + '" name="vat" class="clsvat" value="' + vat + '"/></td>' +
                '<td ><span id="tdSubTotal' + index + '">' + totalAmount.toFixed(2) + '</span><input type="hidden" id="totalAmount' + index +'" name="totalAmount" class="clstotalAmount" value="' + totalAmount + '"/></td>' +
                '<td><a href="javascript:void(0)"style="background-color:red;border-color:red" data-toggle="tooltip" title="Delete" class="btn btn-danger btn-xs" onclick="Delete(' + index + ')"><i class="fa fa-trash"></i></a>'
                '</tr>';
            tableBody.append(trHtml);
            index = index + 1;
            $("#rowCount").val(index);
            $("#onHand").val('');
            ClearLineItem();
            CalculateGrossTotal();
        }

        function AdditemDetailsByAuto(response) {
            if (response == null) {
                swal('Attention', 'No Item Found', 'warning');
                $('#itemName').val('');
                return false;
            }

            var itemName = response.itemName;
            var itemSpecification = response.itemSpecification.specificationName;
            var itemSpecificationId = response.Id;
            //Common.Ajax('GET', '/global/api/OnHanStockBySpecId/' + itemSpecificationId, [], 'json', ajaxSetOnhand, false);
            var onHand = $("#onHand").val();
            $("#onHand").val('');
            var itemSpecificationIdOriginal = response.itemSpecificationId;
            var price = response.price;
            var barcode = response.barcode;
            var quantity = 1;

            var discount = parseFloat(response.discountPersent) ? parseFloat(response.discountPersent) : 0;
            var vat = parseFloat(response.VAT) ? parseFloat(response.VAT) : 0;
            var totalAmount = (price * quantity) - ((price * quantity) * discount / 100) + ((price * quantity) * vat / 100);

            var RowCount = $("#tblitemDetails tbody>tr").length;

            for (i = 1; i <= RowCount; i++) {
                var _itemSpecificationId = $("#itemPriceFixingId" + i).val();
                if (_itemSpecificationId == itemSpecificationId) {
                    alert('You have already added this Item!');
                    return false
                }
            }

            var dtTable = $("#tblitemDetails");
            var tableBody = dtTable.find('tbody');
            var trHtml = '<tr id=' + index + '>' +
                '<td>' + itemName + '</td>' +
                '<td>' + itemSpecification + '<input type="hidden" id="itemPriceFixingId' + index + '" name="itemPriceFixingId[]" class="clsitemSpecificationId" value="' + itemSpecificationId + '"/><input type="hidden" id="IdOriginal" name="IdOriginal[]" value="' + itemSpecificationIdOriginal + '"></td>' +
                '<td>' + price.toFixed(2) + '<input type="hidden" id="priceList' + index + '" name="priceList[]" class="clsprice" value="' + price + '"/><input type="hidden" id="barcode" name="barcode[]" class="clsbarcode" value="' + barcode + '"/></td>' +
                '<td>' + onHand + '<input type="hidden" id="onHand' + index + '" name="onHand" class="clsdiscount" value="' + onHand + '"/></td>' +
                '<td ><input type="number" min="0" id="quantity' + index + '"  onkeyup="fnGrandTotal(' + index + ')" onclick="fnGrandTotal(' + index + ')" name="tblQuantity[]" class="clsquantity text-right" value="' + quantity + '" style="width:100%;padding-right:2px;"  /></td>' +
                '<td>' + discount + '<input type="hidden" id="discount' + index + '" name="discount" class="clsdiscount" value="' + discount + '"/></td>' +
                '<td>' + vat + '<input type="hidden" id="vat' + index + '" name="vat" class="clsvat" value="' + vat + '"/></td>' +
                '<td><span id="tdSubTotal' + index + '">' + totalAmount.toFixed(2) + '</span><input type="hidden" id="totalAmount' + index + '" name="totalAmount" class="clstotalAmount" value="' + totalAmount + '"/></td>' +
                '<td><a href="javascript:void(0)"style="background-color:red;border-color:red" data-toggle="tooltip" title="Delete" class="btn btn-danger btn-xs" onclick="Delete(' + index + ')"><i class="fa fa-trash"></i></a>'
            '</tr>';
            tableBody.append(trHtml);
            index = index + 1;
            $("#rowCount").val(index);
            $("#onHand").val('');
            ClearLineItem();
            CalculateGrossTotal();
        }
        

        function ajaxitemDetailsForEdit(response) {
            console.log(response);
            var dtTable = $("#tblitemDetails");
            var tableBody = dtTable.find('tbody');
            if (response != null) {
                $.each(response, function (i, item) {
                    var discountpresent = item.disAmount
                    if (discountpresent == null)
                    {
                        discountpresent = 0;
                    }
                    var VAT = item.vatAmount
                    if (VAT == null) {
                        VAT = 0;
                    }
                    var totalAmount = (item.rate * item.quantity) - ((item.rate * item.quantity) * item.disAmount / 100)
                    var trHtml = '<tr id=' + index + '>' +
                        '<td>' + item.itemSpecication.Item.itemName + '</td>' +
                        '<td>' + item.itemSpecication.specificationName + '<input type="hidden" id="itemPriceFixingId' + index + '" name="itemPriceFixingId[]" class="clsitemSpecificationId" value="' + item.itemSpecicationId + '"/><input type="hidden" name="IdOriginal[]" value="' + item.itemSpecicationId + '"></td>' +
                        '<td>' + item.rate?.toFixed(2) + '<input type="hidden"  id="priceList' + index + '" name="priceList[]" class="clsprice" value="' + item.rate.price + '"/></td>' +
                        '<td><input type="number" id="quantity' + index + '" onkeyup="fnGrandTotal(' + index + ')" onclick="fnGrandTotal(' + index + ')" name="tblQuantity[]" class="clsquantity" value="' + item.quantity + '" style="width:100%;padding-right:2px;text-align:right" /></td>' +
                        '<td>' + discountpresent + '<input type="hidden" id="discount' + index + '" name="discount" class="clsdiscount" value="' + discountpresent + '"/></td>' +
                        '<td>' + VAT + '<input type="hidden" id="vat' + index + '" name="vat" class="clsvat" value="' + VAT + '"/></td>' +
                        '<td ><span id="tdSubTotal' + index + '">' + totalAmount.toFixed(2) + '</span><input type="hidden" id="totalAmount' + index + '" name="totalAmount" class="clstotalAmount" value="' + totalAmount + '"/></td>' +
                        '<td><a href="javascript:void(0)"style="background-color:red;border-color:red" data-toggle="tooltip" title="Delete" class="btn btn-danger btn-xs" onclick="Delete(' + index + ')"><i class="fa fa-trash"></i></a>'
                    '</tr>';
                    tableBody.append(trHtml);
                    index = index + 1;
                    $("#rowCount").val(index);
                })
            }
            //ClearLineItem();
            //CalculateGrossTotal();
        }

        function Delete(indx) {
            $("#tblitemDetails #" + indx).remove();
            CalculateGrossTotal();
            return false;
        }

        function ClearLineItem() {
            $("#itemName").val('');
            $("#itemId").val('0');
            $("#itemSpecification").val('');
            $("#itemSpecificationId").val('0');
            $("#price").val('');
            $("#quantity").val('');
            $("#discount").val('');
            $("#unit").val('');
        }

        function CalculateGrossTotal() {
            var grossTotal = 0;
            var RowCount = parseInt($("#rowCount").val());
            for (i = 1; i <= RowCount; i++) {
                var _totalAmount = 0;
                if (parseFloat($("#totalAmount" + i).val()) > 0 ) {
                    _totalAmount = parseFloat($("#totalAmount" + i).val());
                }
                grossTotal = grossTotal + _totalAmount;
            }
            $("#grossTotal").val(grossTotal.toFixed(2));
            CalculationNetTotal();
        }

        function CalculationNetTotal() {
            var grossTotal = 0; var grossDiscount = 0; var grossVAT = 0;

            if ($("#grossTotal").val() != "") {
                grossTotal = parseFloat($("#grossTotal").val());
            }

            if ($("#grossDiscount").val() != "") {
                grossDiscount = parseFloat($("#grossDiscount").val());
            }

            if ($("#grossVAT").val() != "") {
                grossVAT = parseFloat($("#grossVAT").val());
            }

            var netAfterDisc = (grossTotal - (grossTotal * grossDiscount / 100));

            var netWithVAT = (netAfterDisc + (netAfterDisc * grossVAT / 100));

            $("#netTotal").val(netWithVAT.toFixed(2));
            $("#bankAmount").val(netWithVAT.toFixed(2));
            $("#cashAmount").val(netWithVAT.toFixed(2));
        }

        function CanculateChange() {
            var netAmount = $("#netTotal").val();
            var GiveAmount = $("#given").val();

            var change = GiveAmount - netAmount;
            $("#change").val(change.toFixed(2));
        }
    </script>


}


