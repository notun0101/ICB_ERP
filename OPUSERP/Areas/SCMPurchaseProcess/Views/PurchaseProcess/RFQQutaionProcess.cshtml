@model PurchaseProcessViewModel
@{
    ViewData["Title"] = "Create CS";
}



<form id="frmQutationProcess" enctype="multipart/form-data">
    <div class="row">
        <div class="col-md-6" style="padding-right:5px;">
            <div style="height:10px;"></div>
            <input type="hidden" name="reqId" id="reqId" value="@Model.reqId" />
            <input type="hidden" name="projectId" id="projectId" value="@Model.projectId" />
            <div class="row">
                <div class="col-sm-6" style="padding-right:5px;">
                    <div class="card">
                        <div class="card-header" style="padding:6px 0px 5px 3px;">
                            <label style="padding:0px 0px 0px 10px;font-size:16px;font-weight:600" class="col-sm-10 pull-left"><i class="fa fa-th-list fa-sm"></i>&nbsp;&nbsp; Procurement Type</label>
                        </div>
                        <div class="card-body p-3 m-0" style="padding-bottom:0px;">
                            <select class="form-control" id="procurementTypeId" name="procurementTypeId">
                                <option value="">Select</option>
                                @foreach (var data in Model.procurementTypes)
                                {
                                    <option value="@data.Id">@data.procurementTypeName</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6" style="padding-left:5px;">
                    <div class="card">
                        <div class="card-header" style="padding:6px 0px 5px 3px;">
                            <label style="padding:0px 0px 0px 10px;font-size:16px;font-weight:600" class="col-sm-10 pull-left"><i class="fa fa-th-list fa-sm"></i>&nbsp;&nbsp; Procurement Value</label>
                        </div>
                        <div class="card-body p-3 m-0" style="padding-bottom:0px;">
                            <select class="form-control" id="procurementValueId" name="procurementValueId">
                                <option value="">Select</option>
                                @foreach (var data in Model.procurementValues)
                                {
                                    <option value="@data.Id">@data.procurementValueName</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6" style="padding-left:5px;">
            <div style="height:10px;"></div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-header" style="padding:6px 0px 5px 3px;">
                            <label style="padding:0px 0px 0px 10px;font-size:16px;font-weight:600" class="col-sm-10 pull-left"><i class="fa fa-th-list fa-sm"></i>&nbsp;&nbsp; CS Number</label>
                        </div>
                        <div class="card-body p-3 m-0" style="padding-bottom:0px;">
                            <div class="row">
                                <input type="text" id="csNumber" name="csNumber" class="form-control" readonly />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-header" style="padding:6px 0px 5px 3px;">
                            <label style="padding:0px 0px 0px 10px;font-size:16px;font-weight:600" class="col-sm-10 pull-left"><i class="fa fa-th-list fa-sm"></i>&nbsp;&nbsp; Expected delivery date</label>
                        </div>
                        <div class="card-body p-3 m-0" style="padding-bottom:0px;">
                            <div class="row">
                                <input type="text" id="deliveryDate" name="deliveryDate" class="form-control input-sm" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="padding-right: 0px;">
        <div class="col-md-12">
            <div style="height:10px;"></div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                        <div class="card-header" style="padding:6px 0px 5px 3px;">
                            <label style="padding:0px 0px 0px 10px;font-size:16px;font-weight:600" class="col-sm-10 pull-left"><i class="fa fa-th-list fa-sm"></i>&nbsp;&nbsp; Create CS: Supplier and Unit price</label>
                        </div>
                        <div class="card-body p-3 m-0" style="padding-bottom:0px;">
                            <table id="tblRequisitionDetails" border="1" style="width:100%;text-align:center">
                                <thead>
                                    <tr id="SubCol" style="color:#482222">
                                        <th></th>
                                        <th colspan="5" style="text-align:center"></th>
                                    </tr>
                                    <tr id="COLName" style="text-align:center;color:#695454">
                                        <th style="text-align:center">Exclude</th>
                                        <th style="text-align:center">Item Code</th>
                                        <th style="text-align:center">Item Name</th>
                                        <th style="text-align:center">PR QTY</th>
                                        <th style="text-align:center">Ordered QTY</th>
                                        <th style="text-align:center">Unit Price</th>
                                        <th style="text-align:center">Item Category</th>
                                        <th style="text-align:center">QTY</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <div class="row" style="padding-right: 0px;">
        <div class="col-md-12">
            <div style="height:10px;"></div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                        <div class="card-header" style="padding:6px 0px 5px 3px;">
                            <label style="padding:0px 0px 0px 10px;font-size:16px;font-weight:600" class="col-sm-10 pull-left"><i class="fa fa-th-list fa-sm"></i>&nbsp;&nbsp; Recommendation: Supplier and QTY</label>
                        </div>
                        <div class="card-body p-3 m-0" style="padding-bottom:0px;">
                            <table id="tblQuotationDetails" border="1" style="width:100%">
                                <thead>
                                    <tr id="QDSubCol" style="color:#482222;text-align:center">
                                        <th colspan="4" style="text-align:center"></th>
                                    </tr>
                                    <tr id="QDCOLName" style="text-align:center;color:#695454">
                                        <th style="width:15%;text-align:center">Item Code</th>
                                        <th style="width:20%;text-align:center">Item Name</th>
                                        <th style="width:8%;text-align:center">PR QTY</th>
                                        <th style="text-align:center">Ordered QTY</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot>
                                    <tr></tr>
                                </tfoot>
                            </table>
                            <div style="text-align:right;font-weight:bolder;"><label id="lbGrandTotal">Total Proposed Procurement value :</label> <label id="lblAllGrandTotal"></label></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="padding-right: 0px;">
        <div class="col-md-12">
            <div style="height:10px;"></div>
            <div class="row">
                <div class="col-sm-7">
                    <div class="card">
                        <div class="card-header" style="padding:6px 0px 5px 3px;">
                            <label style="padding:0px 0px 0px 10px;font-size:16px;font-weight:600" class="col-sm-10 pull-left"><i class="fa fa-th-list fa-sm"></i>&nbsp;&nbsp; Justification for recommendation</label>
                        </div>
                        <div id="divJustification" class="card-body p-3 m-0" style="padding-bottom:0px;max-height:200px;overflow-x:scroll;">
                            <table class="table table-responsive">
                                @foreach (var item in Model.justificationTypes)
                                {
                                    <tr>
                                        <td style="width:40%;padding:0px 0px 0px 0px">@item.justificationTypeName<input type="hidden" value="@item.Id" name="justifyTypeId" /></td>
                                        <td style="padding:0px 0px 0px 0px">
                                            @if (item.defaultValue == 1)
                                            {
                                                <input type="checkbox" id="ck-@item.Id-@item.defaultValue" checked="checked" value="1" class="justify" />
                                                <label for="ck-@item.Id-@item.defaultValue" data-text-true="Yes" data-text-false="No"><i></i></label>
                                            }
                                            else
                                            {
                                                <input type="checkbox" id="ck-@item.Id-@item.defaultValue" value="0" class="justify" />
                                                <label for="ck-@item.Id-@item.defaultValue" data-text-true="Yes" data-text-false="No"><i></i></label>
                                            }

                                            <input type="hidden" name="isJustify" id="hdn-@item.Id" value="0" />
                                        </td>
                                        <td style="padding:0px 0px 0px 0px"><input type="text" class="form-control input-sm" id="txt-@item.Id" name="justifyValue" /></td>
                                    </tr>

                                }

                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-sm-5" style="padding-left:0px;">
                    <div class="card">
                        <div class="card-header" style="padding:6px 0px 5px 3px;">
                            <label style="padding:0px 0px 0px 10px;font-size:16px;font-weight:600" class="col-sm-10 pull-left"><i class="fa fa-th-list fa-sm"></i>&nbsp;&nbsp; CS Supporting Documents Attachment</label>
                        </div>
                        <div class="card-body p-3 m-0" style="min-height: 200px;">
                            <div class="row">
                                <div class="col-md-7" style="padding:0px 10px 0px 10px">
                                    <div class="form-group" style="padding:0px 10px 0px 10px">
                                        <input type="text" id="SubjectName" class="form-control input-sm" placeholder="Subject" />
                                    </div>
                                </div>
                                <div class="col-md-5" style="padding:0px 10px 0px 10px">
                                    <div class="form-group" style="padding:0px 10px 0px 10px">
                                        <label for="files" class="btn btn-success btn-sm" style="width:145px;background-color:rgb(26,187,156);color:white">
                                            Choose file
                                        </label>
                                        <div style="display:none;">
                                            <input type="file" name="files" id="files" multiple="multiple" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row" style="background-color:white;max-height:123px;overflow-x:scroll;">
                                <table id="dtCSAttachment" class="table table-bordered" style="width:100%;">
                                    <thead style="background-color:#e6e7ed"><tr><th style="width:50%">File Name</th><th style="width:20%">Subject</th><th style="width:10%">File</th><th style="width:20%;">Action</th></tr></thead>
                                    <tbody id="tbodyAttachment"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  

    <div style="height:10px;"></div>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="row" style="padding-top:0px;padding-bottom:0px;padding-left:10px;">
                    <div class="col-sm-9">
                        <div id="progress" style="display:none; align-content:center;">
                            <span class="text-success"> <b>Please wait while data is Processing ......    </b></span><img src="~/images/spinner.gif" />
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <input type="button" name="Cancel" id="btnCancel" value="Cancel" class="btn btn-secondary" onclick="location.href='@Url.Action("Index", "PurchaseProcess","SCMPurchaseProcess")'" style="width:100px;" />&nbsp;&nbsp;
                        <input type="submit" name="Save" id="btnSubmit" value="Confirm" class="btn btn-success" style="width:100px;" />
                    </div>

                </div>
            </div>
        </div>
    </div>
</form>


@section Scripts{
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-migrate-3.0.0.min.js" type="text/javascript"></script>
    <script type="text/javascript">
            var formdata = new FormData();
            var deleteClm = 0;
            var footCount = 1;
            var validQty = true;
            var unorderedPRQty = 0;
            var deleteRow = 0;
            var ColQ = 1;
            var Indexattach = 0;
            var isValid = true;

            function DeleteColumn(ColumnCnt) {
                $("#thColmn" + ColumnCnt).remove();
                $("#COLName #thColmn" + ColumnCnt).remove();
                $(".tdColmn" + ColumnCnt).remove();
                $("#QDCOLName #thColmn" + ColumnCnt).remove();
                //$("#lblCompanyTotal" + ColumnCnt).remove();
                deleteClm = deleteClm + 1;
            }

            function ckValidPerItem(isValid) {
                if ($('#procurementValueId').val() == "1") {
                    var ColumnCnt = $("#tblRequisitionDetails thead #COLName th").length;
                    var rowCnt = $("#tblRequisitionDetails tbody tr").length;
                    var ComCount = ColumnCnt - 8;

                    for (i = 0; i < rowCnt; i++) {
                        var ckloop = false; var CC = 0;
                        for (s = 8; s < ColumnCnt; s++) {
                            var itemRateID = $('#tblQuotationDetails #itemRate' + i + s).html();
                            //alert(itemRateID);
                            if (itemRateID == "undefined" || itemRateID == "0.00" || itemRateID == "" || itemRateID == "0") {
                                CC = parseInt(CC) + 1;
                                //alert('CC ' + CC);
                            }
                            if (parseInt(ComCount) - CC < 2) {
                                swal({ title: 'Attention!', text: "Must be entred 2 bidder's rate per item.", timer: 6000 })
                                isValid = false; ckloop = true;
                                break;
                            }
                        }
                        if (ckloop) {
                            break;
                        }
                    }
                }
                if (isValid) {
                    return true;
                }
                else {
                    return false;
                }
            }

            $(document).ready(function () {
                $('#csNumber').val('@ViewBag.CSNumber');


                $('#deliveryDate').flatpickr({ dateFormat: "d-M-Y", minDate: "@DateTime.Now.ToString("MM/dd/yyyy")" });
                $('#deliveryDate').val("@DateTime.Now.ToString("dd-MMM-yyyy")");
                $('#reqQty').keyup(function () {
                    CalculateAmount();
                });
                $('#reqRate').keyup(function () {
                    CalculateAmount();
                });

                $('#procurementTypeId').change(function () {
                    if ($('#procurementTypeId').val() != "" && $('#procurementValueId').val() != "") {
                        $('#organization').prop('readonly', false);
                    }
                    else {
                        $('#organization').prop('readonly', true);
                        $('#organization').val('');
                        $('#organizationId').val('');
                    }
                });
                $('#procurementValueId').change(function () {
                    if ($('#procurementTypeId').val() != "" && $('#procurementValueId').val() != "") {
                        $('#organization').prop('readonly', false);
                    }
                    else {
                        $('#organization').prop('readonly', true);
                        $('#organization').val('');
                        $('#organizationId').val('');
                    }

                    var ColumnCnt = $("#tblRequisitionDetails thead #COLName th").length;
                    var ComCount = ColumnCnt - 8;
                    var thisVal = $(this).val();
                    if ((thisVal != '1') && ComCount > 1) {
                        swal('Attention!', "You are allowed keep one bidder", 'warning');
                        $(this).val(1);
                        return false;
                    }

                });


                $(document).on("click", "input[class = 'justify']", function (e) {
                    var id = this.getAttribute('id');
                    var jid = id.split('-')[1];
                    var defaultval = id.split('-')[2];
                    var val = $('#' + id).val();
                    if (this.checked) {
                        if (defaultval == 0) {
                            $(this).attr("value", "1");
                            $('#hdn-' + jid).val(1);
                            $('#txt-' + jid).prop("readonly", true).css({ "background-color": "#c4c2be" });
                            $('#txt-' + jid).val('');
                        } else {
                            $(this).attr("value", "0");
                            $('#hdn-' + jid).val(0);
                            $('#txt-' + jid).prop("readonly", false).css({ "background-color": "white" });
                        }
                    } else {
                        if (defaultval == 0) {
                            $(this).attr("value", "1");
                            $('#hdn-' + jid).val(1);
                            $('#txt-' + jid).prop("readonly", false).css({ "background-color": "white" });
                        } else {
                            $(this).attr("value", "0");
                            $('#hdn-' + jid).val(0);
                            $('#txt-' + jid).prop("readonly", true).css({ "background-color": "#c4c2be" });
                            $('#txt-' + jid).val('');
                        }

                    }
                });

                $("#btnSubmit").click(function (e) {
                    var tblReqCnt = $("#tblRequisitionDetails tbody tr").length;
                    var tblQutation = $('#tblQuotationDetails tbody>tr').length;
                    var attchCount = $('#dtCSAttachment tbody>tr').length;
                    var procurementTypeId = $('#procurementTypeId').val();
                    var procurementValueId = $('#procurementValueId').val();
                    var deliveryDate = $('#deliveryDate').val();

                    var AllCompany = new Array();

                    var $allConpanys = $("#tblRequisitionDetails").find(".clCompany");
                    $allConpanys.each(function () {
                        var Value = $(this).val();
                        AllCompany[AllCompany.length] = Value;
                    });

                    if (tblQutation == 0) {
                        swal("Attention!", "Invalid Attempt!!!", "warning");
                        return false;
                    }
                    //else if (attchCount == 0) {
                    //    swal("Attention!", "Please Select CS Attachment!!", "warning");
                    //    return false;
                    //}
                    else if ($('#rfqReference').val().trim() == '') {
                        swal("Attention!", "Please Entred RFQ Reference!!", "warning");
                        return false;
                    } else if ((procurementValueId == "1") && AllCompany.length < 2) {
                        swal('Attention!', "At least 2 bidder's information must be given in CS.", 'warning');
                        return false;
                    } else if (procurementTypeId == "" || procurementValueId == "") {
                        swal("Attention!", "Please Select Procurement Info!!", "warning");
                        return false;
                    } else if ($('#ck-3-1').val() == 1 && $('#txt-3').val() == '') {
                        swal("Attention!", "Please Entered Advance Payment!!", "warning");
                        return false;
                    } else if (($('#ck-1-0').val() == 0 && $('#txt-1').val() == '' ) ) {
                        swal("Attention!", "Please Entered Lowest bidder!!", "warning");
                        return false;
                    } else if (($('#ck-2-0').val() == 0 && $('#txt-2').val() == '')) {
                        swal("Attention!", "Please Enter Proposed payment term agreed!!", "warning");
                        return false;
                    } else if (($('#ck-4-0').val() == 0 && $('#txt-4').val() == '')) {
                        swal("Attention!", "Please Enter Proposed compensation clause agreed!!", "warning");
                        return false;
                    }

                    isValid = ckValidPerItem(true);
                    if (!isValid) {
                        return false;
                    }

                    e.preventDefault();

                    var form = $("#frmQutationProcess");
                    swal({
                        title: 'Are you sure?', text: 'Are you sure you want to Save this records?', type: 'warning', showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Yes, Save it!'
                    }).then(function () {
                        $('#btnSubmit').prop('disabled', true);
                        $('#progress').show();
                        $.ajax({
                            url: '@Url.Action("QutaionProcess", "PurchaseProcess")',
                            data: form.serialize(),
                            type: 'POST',
                            success: function (data) {
                                if (attchCount > 0) {
                                    UploadAttachment(data);
                                }
                                else {
                                    $('#btnSubmit').prop('disabled', false);
                                    $('#progress').hide();
                                    swal('Saved!', 'Saved Successfully', 'success').then(function () {
                                        window.location = '@Url.Action("Index", "PurchaseProcess")';
                                    });
                                }
                            },
                            failure: function () {
                                swal("unable to Save!!");
                                $('#btnSubmit').prop('disabled', false);
                                $('#progress').hide();
                            }
                        });
                    });
                });

                //$('#btnSubmit').prop('disabled', true);

                LoadAttachment();

                Common.Ajax('GET', '/global/api/supplier/GetAllSupplier/', [], 'json', ajaxGetAllSupplier);
                Common.Ajax('GET', '/global/api/GetRequisitionDetailListForBuyer/' + @ViewBag.reqMasterId, [], 'json', ajaxGetRequisitionDetailBuyer);


                if (window.File && window.FileList && window.FileReader) {
                    var filesInput = document.getElementById("files");
                    filesInput.addEventListener("change", function (event) {
                        //ajaxGetRequisitionDetailBuyer
                        var files = event.target.files; //FileList object

                        var subject = $("#SubjectName").val();

                        for (var i = 0; i < files.length; i++) {
                            var file = files[i];
                            Indexattach = Indexattach + 1;
                            var attach_id = "files";
                            var FileSize = $('#' + attach_id)[0].files[0].size;
                            var fileName = $('#' + attach_id)[0].files[0].name;
                            var path = URL.createObjectURL(event.target.files[0]);

                            var filesizekb = (parseFloat(FileSize) / 1024).toFixed(0);
                            var maxfilesize = (parseFloat(filesizekb) / 1024).toFixed(0);
                            if (parseFloat(maxfilesize) > 4) {
                                alert('File size must be less then 4 Mb');
                                return false;
                            }
                            var dtTable = $("#dtCSAttachment");
                            var tableBody = dtTable.find('tbody');
                            var backcolor = '';
                            if (Indexattach % 2 != 0) {
                                backcolor = "background-color:#ffffff";
                            }
                            else {
                                backcolor = "background-color:#e6e7ed";
                            }

                            if (!file.type.match('image')) //file
                            {
                                var ext = this.value.match(/\.(.+)$/)[1];
                                var picReader = new FileReader();
                                picReader.addEventListener("load", function (event) {
                                    var attach_id = "files";
                                    var picFile = event.target;

                                    tableBody.append(
                                        '<tr style=' + backcolor + ' id=' + Indexattach + '>' +
                                        '<td style="padding:0px 0px 0px 0px">' + fileName + '</td>' +
                                        '<td style="padding:0px 0px 0px 0px">' + subject + '<input type="hidden" class="clsFileTitle" value="' + subject + '" /></td>' +
                                        '<td style="padding:0px 0px 0px 0px"><i class="fa fa-file" style="font-size:25px;color:lightgray"> </i></td>' +
                                        '<td style="padding:0px 0px 0px 0px"><a href=' + "'" + path + "'" + '  target="_blank"  title="Preview"  class="btn btn-info btn-xs"><i class="fa fa-eye"></i></a>' + '&nbsp;&nbsp;' + '<a href="javascript:void(0)" class="btn btn-danger btn-xs" title="Delete" onclick="DeleteImage(' + Indexattach + ',' + "'" + fileName + "'" + ')"><i class="fa fa-trash"></i></a></td>' +
                                        '</tr>')
                                });
                            }
                            else {
                                var ext = this.value.match(/\.(.+)$/)[1];
                                var picReader = new FileReader();
                                picReader.addEventListener("load", function (event) {
                                    var attach_id = "files";
                                    var picFile = event.target;
                                    tableBody.append(
                                        '<tr style=' + backcolor + ' id=' + Indexattach + '>' +
                                        '<td style="padding:0px 0px 0px 0px">' + fileName + '</td>' +
                                        '<td style="padding:0px 0px 0px 0px">' + subject + '<input type="hidden" class="clsFileTitle" value="' + subject + '" /></td>' +
                                        '<td style="height:25px;width: 25px; background - color:lightgray;padding:0px 0px 0px 0px"><img src=' + "'" + path + "'" + ' height=25 width=25 /></td>' +
                                        '<td style="padding:0px 0px 0px 0px"><a href=' + "'" + path + "'" + '  target="_blank"  title="Preview"  class="btn btn-info btn-xs"><i class="fa fa-eye"></i></a>' + '&nbsp;&nbsp;' + '<a href="javascript:void(0)" class="btn btn-danger btn-xs" title="Delete" onclick="DeleteImage(' + Indexattach + ',' + "'" + fileName + "'" + ')"><i class="fa fa-trash"></i></a></td>' +
                                        '</tr>')
                                });
                            }
                            picReader.readAsDataURL(file);
                        }
                        var fileInput = document.getElementById('files');
                        for (i = 0; i < fileInput.files.length; i++) {
                            formdata.append(fileInput.files[i].name, fileInput.files[i]);
                        }
                        $("#SubjectName").val('');
                    });
                }
                else {
                    console.log("Your browser does not support File API");
                }

                $(".numeric").keydown(function (e) {
                    if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                        (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                        (e.keyCode >= 35 && e.keyCode <= 40)) {
                        return;
                    }
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });

            });

            function DeleteImage(Indexattach, fileName) {
                //$("#btnDelete"+Index).remove();
                if (Indexattach > 1) {
                    $('#btnSubmit').prop('disabled', false);
                }
                else {
                    $('#btnSubmit').prop('disabled', true);
                }
                formdata.delete(fileName);
                $("#dtCSAttachment #" + Indexattach).remove();
                Indexattach = Indexattach - 1;
                return false;
            }

            function UploadAttachment(id) {

                if (window.FormData !== undefined) {
                    var arrayFileAtach = [];
                    var $FileAtach = $('.clsFileTitle');
                    $FileAtach.each(function () {
                        arrayFileAtach.push($(this).val());
                        formdata.append("id", id);
                        formdata.append("arrayFileAtach", arrayFileAtach);
                        arrayFileAtach = [];
                    });

                    $.ajax({
                        url: '@Url.Action("UploadCSAttachment", "PurchaseProcess")',
                        type: "POST",
                        contentType: false,
                        data: formdata,
                        dataType: "json",
                        processData: false,
                    })
                        .done(function (data) {
                            $('#btnSubmit').prop('disabled', false);
                            $('#progress').hide();
                            swal('Saved!', 'Saved Successfully', 'success').then(function () {
                                window.location = '@Url.Action("Index", "PurchaseProcess")';
                            });
                        })
                        .fail(function () {
                            $('#btnSubmit').prop('disabled', false);
                            $('#progress').hide();
                            alert("Uploading failed");
                        })
                } else {
                    alert("FormData is not supported.");
                }
            }

        function ajaxGetRequisitionDetailBuyer(response) {

            var rocn = 1;
            var dtTable = $("#tblRequisitionDetails");
            var dtTable2 = $("#tblQuotationDetails");

            var tableBody = dtTable.find('tbody');
            var tableBody2 = dtTable2.find('tbody');
            tableBody.empty();
            tableBody2.empty();
            $.each(response, function (index, E) {
                var backcolor = '';
                if (rocn % 2 != 0) {
                    backcolor = "background-color:#e6e7ed";
                }
                else {
                    backcolor = "background-color:#ffffff";
                }
                ColQ = $("#tblQuotationDetails tbody tr").length + 1;
                var ordercnt = "txtOrderQty" + rocn;
                tableBody.append(
                    '<tr style=' + backcolor + ' id=' + E.requisitionDetailId + ' class="clsRequisitionDetail">' +
                    '<td><a href="javascript:void(0)" class="btn btn-danger btn-xs" title="Exclude" onclick="deleteItem(' + E.requisitionDetailId + ')"><i class="fa fa-trash"></i></a></td>' +
                    '<td style="text-align:center">' + E.itemCode + '</td>' +
                    '<td style="text-align:center">' + E.itemName + '<input type="text" id="txt' + E.itemId + '" class="clItemId" style="display:none" value="' + E.itemId + '" /></td>' +
                    '<td style="text-align:center">' + E.reqQty + '</td>' +
                    '<td style="text-align:center">' + E.csQty +'</td>' +
                    '<td style="text-align:center">' + E.reqRate+'</td>' +
                    //'<td style="text-align:center"><select id=ddlItemType class="clsddlItemType" name="itemCatId"><option value="" selected="selected">Select Item Category</option>' +
                    '<td style="text-align:center"><select id=ddlItemType class="clsddlItemType" name="itemCatId">' +
                    '<option value="1">Technology</option>' +
                    '<option value="2">Fleet</option>' +
                    '<option value="3">General supply</option>' +
                    '<option value="4">Digital print</option>' +
                    '<option value="5">Offset print</option>' +
                    '<option value="6">Gift items</option>' +
                    '<option value="7">Events and activation</option>' +
                    '<option value="8">Media buying</option>' +
                    '<option value="9">OOH (Out of Home)</option>' +
                    //'<option value="10">Outsource and General Service</option>' +
                    //'<option value="11">Renovation</option>' +
                    //'<option value="12">Premise Rental</option></td>' +
                    '<td style="text-align:center">' + 1 + '</td>' +
                    '</tr>')
                tableBody2.append(
                    '<tr style=' + backcolor + ' id="' + E.requisitionDetailId + '" >' +
                    '<td style="text-align:center">' + E.itemCode + '<input type="text" class="clReqDID" style="display:none" value="' + E.requisitionDetailId + '" name="reqDetailsId" /></td>' +
                    '<td style="text-align:center">' + E.itemName + '<input type="text" id="txt' + E.itemId + '" class="clItemId" style="display:none" value="' + E.itemId + '" /></td>' +
                    '<td style="text-align:center">' + E.reqQty + '<input type="text" id="txtReqQty' + ColQ + '" class="clReqQTY" style="display:none" value="' + E.reqQty + '" /></td>' +
                    '<td style="text-align:center">'+E.csQty+'</td>' +
                    '<td style="display:none"></td>' +
                    '<td style="display:none"></td>' +
                    '<td style="display:none"></td>' +
                    '<td style="display:none"></td>' +
                    '</tr>')

                rocn = rocn + 1;
            });

        }

        function ajaxGetAllSupplier(response) {
            var GetList = [];
            $.each(response, function (id, option) {
                var obj = new Object();
                obj.key = option.Id;
                obj.value = option.orgCode + '-' + option.organizationName;
                GetList[GetList.length] = obj;
            });
            $('#organization').autocomplete({
                source: GetList,
                select: function (event, ui) {
                    $("#organization").val(ui.item.value);
                    $("#organizationId").val(ui.item.key);
                }
            });
        }

        function LoadAttachment() {
            var rowno = 0
            $.ajax({
                type: 'GET',
                contentType: "application/json; charset=utf-8",
                url: '/SCMRequisition/RequisitionApprove/GetAttachmentListByMatrixType?masterId=' + @ViewBag.reqMasterId,
                data: {},
                dataType: 'json',
                async: true,
                success: function (attachments) {
                    var index = 1;
                    var dtTable = $("#dtAttachment");
                    var tableBody = dtTable.find('tbody');
                    tableBody.empty();
                    $.each(attachments, function (index, E) {
                        rowno = rowno + 1;
                        var filePath = '/Upload/'+E.fileName
                        $('#SubjectName').val(E.Subject);
                        if (E.FilePath != "") {
                            if (E.MimeType == "application/msword" || E.MimeType == "application/pdf" || E.MimeType == "application/x-msexcel" || E.MimeType == "application/octet-stream" || E.MimeType == "text/plain" || E.MimeType == "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || E.MimeType == "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet") {
                                tableBody.append(
                                    '<tr id=' + rowno + '>' +
                                    '<td>' + E.fileName + '</td>' +

                                    '<td><i class="fa fa-file" style="font-size:40px;color:lightgray"> </i></td>' +
                                    '<td><a href=' + "'" + filePath + "'" + '  target="_blank"  title="Preview"  class="btn btn-info btn-sm"><i class="fa fa-eye"></i></a></td>' +
                                    '</tr>')
                            }
                            else {
                                tableBody.append(
                                    '<tr id=' + rowno + '>' +
                                    '<td>' + E.fileName + '</td>' +

                                    '<td style="height:50px;width: 45px; background - color:lightgray"><img src=' + "'" + filePath + "'" + ' height=50 width=45 /></td>' +
                                    '<td><a href=' + "'" + filePath+ "'" + '  target="_blank"  title="Preview"  class="btn btn-info btn-sm"><i class="fa fa-eye"></i></a></td>' +
                                    '</tr>')
                            }
                        }
                        index = index + 1;
                    });
                    $('#AjaxLoader').hide()
                },
                error: function (request, status, error) {
                    alert(request.statusText + "/" + request.statusText + "/" + error);
                }
            });
        }

        function AddCompany() {
            var tester = true;
            var CompanyName = $("#organization").val();
            var CompanyId = $("#organizationId").val();
            var sor = $("#Competitive").val();
            var PF = $("#PostFactor").val();
            var CW = $("#CompetitionWaiver").val();
            var SS = $("#SingleSource").val();
            var SV = $("#RepeatOrder").val();
            if (CompanyId == "") {
                swal("Attention!", "Please add valid Vendor");
                return false;
            }
            if ((SV == "1" || PF == "1" || CW == "1" || SS == "1") && footCount > 1) {
                var tester = false;
            }

            // AddSupplierList[AddSupplierList.length] = CompanyId;

            if (comValidation(CompanyId) == true && tester == true) {
                var dtTable = $("#tblRequisitionDetails");
                var dtMainColHead = dtTable.find('thead #MainCol');
                var dtSubColHead = dtTable.find('thead #SubCol');
                var dtHead = dtTable.find('thead #COLName');
                var tableBody = dtTable.find('tbody tr');

                var dtTable2 = $("#tblQuotationDetails");
                var dtMainColHead2 = dtTable2.find('thead #QDMainCol');
                var dtSubColHead2 = dtTable2.find('thead #QDSubCol');
                var dtHead2 = dtTable2.find('thead #QDCOLName');
                var tableBody2 = dtTable2.find('tbody tr');//tfoot
                var tableFoot2 = dtTable2.find('tfoot tr');

                var ColumnCnt = $("#tblRequisitionDetails thead #COLName th").length + deleteClm;

                var RowCount = $("#tblRequisitionDetails thead #COLName>th").length;

                for (i = 1; i <= RowCount; i++) {
                    var Comp_ID = $("#txtCompID" + i).val()
                    if (Comp_ID == CompanyId) {
                        swal("Attention!", "You have already add this Vendor")
                        return false
                    }
                }

                //var  ckCSSupplierExist(supplierID)

                var MainColCnt = dtTable.find('thead #MainCol th').length;
                var SubColCnt = dtTable.find('thead #SubCol th').length;
                //var rowCnt = $("#tblRequisitionDetails tbody tr").length;

                var QDMainColCnt = dtTable2.find('thead #QDMainCol th').length;
                var QDSubColCnt = dtTable2.find('thead #QDSubCol th').length;

                if (MainColCnt < 2) {
                    dtMainColHead.append('<th></th>')
                }
                if (SubColCnt < 3) {
                    dtSubColHead.append('<th colspan="' + ColumnCnt + '" style="text-align:center"><b>Comparative  Statement in Unit Price including tax</b></th>')
                }

                if (QDMainColCnt < 2) {
                    dtMainColHead2.append('<th></th>')
                }

                if (QDSubColCnt < 2) {
                    dtSubColHead2.append('<th colspan="' + ColumnCnt + '" style="text-align:center"><b>Supplier wise order QTY and Value</b></th>')
                }

                dtHead.append('<th  style="text-align:center" id="thColmn' + ColumnCnt + '">' + CompanyName + '<input type="text" id="txtCompID' + ColumnCnt + '" class="clCompany" value="' + CompanyId + '" style="display:none"/><button style="color:red;background-color:rgb(62,82,102);border: 0; background: none; box-shadow:none; border-radius: 0px;" id="btnClm' + ColumnCnt + '" onclick="DeleteColumn(' + ColumnCnt + ')">X</button></th>')

                tableBody.append('<td  class="tdColmn' + ColumnCnt + '"><input type="text" palaceholder="0.00"  id="txtRate' + ColumnCnt + '"  onkeyup="QuotationTableGenerate(this)"  class="clqtyRate" name="csRate" style="text-align:right;padding-right:5px;max-width:120px"/></td>')

                dtHead2.append('<th  style="text-align:center" id="thColmn' + ColumnCnt + '">' + CompanyName + '<input type="text" class="clCompany" value="' + CompanyId + '" name="supplierId" style="display:none;text-align:center"/></th>')

                tableBody2.append('<td class="tdColmn' + ColumnCnt + '"><input type="text"  onkeyup="fnMultiQtyRate(this,' + ColumnCnt + ')"  class="clqty" name="csQty" style="max-width:100px;text-align:center;"/>&nbsp;&nbsp; X &nbsp;<label class="clqtyRate">0.00</label><br />&nbsp;<b>=</b>&nbsp;<label class="cltTotal" name="companyTotal' + ColumnCnt + '"></label></td>')

                if (footCount == 1) {
                    tableFoot2.append('<td></td><td style="text-align:center"><b>Total:</b></td><td></td><td></td><td class="tdColmn' + ColumnCnt + '" style="text-align:center"><label id="lblCompanyTotal' + ColumnCnt + '"></label></td>')

                    //dtHead.append('<th style="text-align:center" id="WH">WH Status</th>')
                    //tableBody.append('<td class="CH"><input type="checkbox" /><input type="text" id="txtCH" /></td>')
                }
                else {
                    tableFoot2.append('<td class="tdColmn' + ColumnCnt + '" style="text-align:center"><label id="lblCompanyTotal' + ColumnCnt + '"></label></td>')
                    //$("#WH").remove();
                    //$(".CH").remove();
                    //dtHead.append('<th style="text-align:center" id="WH">WH Status</th>')
                    //tableBody.append('<td class="CH"><input type="checkbox" /><input  id="txtCH ' + ColumnCnt + '" class="clCH" name="WHCK" /></td>')
                }
                footCount = footCount + 1;
            }

            else {
                swal('Attention!', "You can't add more than one bidder", 'warning')
            }
            $("#organization").val('');
            $("#organizationId").val('');

            $(".clqty").keydown(function (e) {
                if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                    (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                    (e.keyCode >= 35 && e.keyCode <= 40)) {
                    return;
                }
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
        }

        function comValidation(CompanyId) {
            if ($("#txtcompany" + CompanyId).val() == CompanyId || $("#txtcompany" + CompanyId).val() == "undefinied") {
                return false;
            }
            else {
                return true;
            }

        }

        function QuotationTableGenerate() {

            $(".clqtyRate").keydown(function (e) {
                if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                    (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                    (e.keyCode >= 35 && e.keyCode <= 40)) {
                    return;
                }
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });


            //$('#tblRequisitionDetails .clqtyRate').number(true);
            var cc = 1;
            var ColumnCnt = $("#tblRequisitionDetails thead #COLName th").length + deleteClm;
            var rowCnt = $("#tblRequisitionDetails tbody tr").length;
            var ir = 1;
            for (i = 0; i < rowCnt; i++) {
                var cc = 1;

                for (s = 1; s <= ColumnCnt; s++) {

                    var ReqDetailRate = $('#tblRequisitionDetails tbody tr').eq(i).find('td').eq(s).find(".clqtyRate").val();
                    $('#tblQuotationDetails tbody tr').eq(i).find('td').eq(s).find(".clqtyRate").html(ReqDetailRate);
                    $('#tblQuotationDetails tbody tr').eq(i).find('td').eq(s).find(".clqty").attr("id", "txt-itemRate" + i + s + "");
                    $('#tblQuotationDetails tbody tr').eq(i).find('td').eq(s).find(".clqtyRate").attr("id", "itemRate" + i + s + "");
                    $('#tblQuotationDetails tbody tr').eq(i).find('td').eq(s).find(".cltTotal").attr("id", "totalitemRate" + i + s + "");
                    $('#tblQuotationDetails tbody tr').eq(i).find('td').eq(s).find(".clReqQTY").attr("id", "txtReqQty" + ir + "");
                }
                //alert('s '+s);
                $('#tblQuotationDetails .clqtyRate').number(true, 2);
                ir = ir + 1;
            }
            //alert('i ' + i);
        }

        function fnMultiQtyRate(arg, columnNo) {
            var txtId = arg.getAttribute('id');
            if (!txtId) {
                return false;
            }
            var txtrow = txtId.substring(0, 13);


            validQty = qtyperitemValidation(txtrow);
            if (validQty) {
                var txtRate = txtId.split("-")[1]
                var Qty = $("#" + txtId).val();
                var Rate = $("#" + txtRate).html().replace(/,/g, "");
                var totalLebel = "total" + txtRate;

                var Total = parseFloat(Qty) * parseFloat(Rate);
                $("#" + totalLebel).html(parseFloat(Total)).number(true, 2);

                var $allGrandTotal = $('#tblQuotationDetails td').find(".cltTotal");// $('#tblQuotationDetails td').eq(7).find(".cltTotal");
                var allGrandTotal = 0;
                $allGrandTotal.each(function () {

                    var value = $(this).html().replace(/,/g, "");
                    if (value != '') {
                        allGrandTotal = parseFloat(allGrandTotal) + parseFloat(value);
                    }
                });
                $("#lblAllGrandTotal").html(parseFloat(allGrandTotal)).number(true, 2);
                /// Company wise Total
                var sum = 0;
                $("[name^=companyTotal" + columnNo + "]").each(function () {
                    //alert(totalLebel);
                    var value = $(this).html().replace(/,/g, "");
                    if (value != '') {
                        sum = sum + parseFloat(value);
                    }
                }
                );
                $("#lblCompanyTotal" + columnNo + "").html(parseFloat(sum)).number(true, 2);
            }
            else {
                swal({ title: 'Attention!', text: "Recommandation Qty must be less then PR Qty.Remaining PR Qty is '" + unorderedPRQty + "'", timer: 8000 });
                $("#" + txtId).val('');
                validQty = true;
            }
        }

        function qtyperitemValidation(txtrow) {
            var ColumnCnt = $("#tblQuotationDetails thead #QDCOLName th").length + deleteClm;
            var rowCnt = $("#tblQuotationDetails tbody tr").length + deleteRow;
            var ComCount = ColumnCnt + 3;
            var rowNum = txtrow.substring(12, 13);
            var txtrowNum = parseInt(rowNum) + 1;
            var reqQtq = $('#txtReqQty' + txtrowNum).val();
            var TQty = 0;

            for (s = 7; s <= ComCount; s++) {
                var ckloop = false;
                var curqty = parseInt($('#' + txtrow + s).val());
                if (isNaN(curqty) == true) {
                    curqty = 0;
                }
                TQty = curqty + parseInt(TQty);
                if (reqQtq < TQty) {
                    //swal({ title: 'Attention!', text: "Recommandation Qty must be less then PR Qty", timer: 4000 });
                    ckloop = true;
                    validQty = false;
                }
                if (ckloop) {
                    unorderedPRQty = reqQtq;
                    break;
                }
            }
            if (validQty) {
                return true;
            }
            else {
                return false;
            }
        }

        function deleteItem(ID) {
            $("#" + ID).remove();
            $("#tblQuotationDetails").find('tbody #' + ID).remove();
            deleteRow = deleteRow + 1
            return false;
        }

    </script>

}

<style>
    dt {
        padding-right: 0px;
    }

    dd {
        padding-left: 0px;
    }

    /*For Justify Style*/

    .justify {
        display: none;
    }

    #divJustification input[type=checkbox] + label {
        display: inline-block;
        background-color: #fe48a6;
        color: white;
        font-family: sans-serif;
        font-size: 14px;
        font-weight: bold;
        height: 30px;
        line-height: 30px;
        position: relative;
        text-transform: uppercase;
        width: 80px;
    }

        #divJustification input[type=checkbox] + label,
        #divJustification input[type=checkbox] + label i {
            -webkit-transition: all 200ms ease;
            -moz-transition: all 200ms ease;
            -o-transition: all 200ms ease;
            transition: all 200ms ease;
        }

    #divJustification input[type=checkbox]:checked + label {
        background-color: #67B04F;
    }

    #divJustification input[type=checkbox] + label:before,
    #divJustification input[type=checkbox] + label:after,
    #divJustification input[type=checkbox] + label i {
        width: 50%;
        display: inline-block;
        height: 100%;
        text-align: center;
    }

    #divJustification input[type=checkbox] + label:before {
        content: attr(data-text-true);
    }

    #divJustification input[type=checkbox] + label:after {
        content: attr(data-text-false);
    }

    #divJustification input[type=checkbox] + label i {
        top: 10%;
        background-color: white;
        height: 80%;
        left: 5%;
        position: absolute;
        width: 45%;
    }

    #divJustification input[type=checkbox]:checked + label i {
        left: 50%;
    }

    /*End Justify*/
</style>

