
@model AgreementViewModel
@{
    ViewData["Title"] = "Agreement";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int masterId = Convert.ToInt32(ViewBag.masterId);
    //Layout = "~/Areas/CRMLead/Views/Shared/_LeadForm.cshtml";
}

<div class="row clearfix">
    <div class="col-12">
        <div class="card mb-4">
            @*<div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Agreement</h6>

                </div>*@
            <div class="card-body">
                <div class="container" id="entrydata">
                    <form asp-area="CRMLead" asp-controller="Agreement" asp-action="SaveAgreementNewLead" method="post" data-parsley-validate="parsley">
                        <div asp-validation-summary="All" class="text-danger"></div>
                        <div>
                            <label style="padding:0px 0px 0px 0px;font-size:18px;font-weight:600;color:black;" class="col-sm-10 pull-left">Agreement Information</label>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="leadName" class="col-sm-4 col-form-label">Lead Name<span style="float:right;color:red;">*</span></label>
                                    <div class="col-sm-8">
                                        <input type="text" data-parsley-required="true" data-parsley-trigger="keyup" class="form-control" name="leadName" id="leadName" value="@ViewBag.leadName" readonly="readonly">
                                        @*<input type="hidden" name="leadsId" id="leadsId" value="0" />*@
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <input type="hidden" name="agreementId" id="agreementId" value="0" />
                                    <input type="hidden" name="agreementStatusId" id="agreementStatusId" value="1" />
                                    <input type="hidden" id="leadsId" name="leadsId" value="@ViewBag.leadId">
                                    <input type="hidden" id="isPersonal" name="isPersonal" value="1">
                                    <label for="agreementTypeId" class="col-sm-4 col-form-label">Agreement Type</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="agreementTypeId" name="agreementTypeId" data-parsley-required="true">
                                            <option value="">Select Agreement Type</option>
                                            @foreach (var data in Model.agreementTypes)
                                            {
                                                <option value="@data.Id">@data.agreementTypeName</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="agreementNo" class="col-sm-4 col-form-label">Agreement No</label>
                                    <div class="col-sm-8">
                                        <input type="text" data-parsley-required="true" class="form-control" name="agreementNo" id="agreementNo" readonly value="@ViewBag.agreementNo">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="agreementCategoryId" class="col-sm-4 col-form-label">Category</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="agreementCategoryId" name="agreementCategoryId" data-parsley-required="true">
                                            <option value="">Select Category</option>
                                            @foreach (var data in Model.agreementCategories)
                                            {
                                                <option value="@data.Id">@data.agreementCategoryName</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="noOfReports" class="col-sm-4 col-form-label">No. Of Reports</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control numeric" name="noOfReports" id="noOfReports" style="text-align:right;" maxlength="3">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="loanLimitAmount" class="col-sm-4 col-form-label">loan Limit</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control numeric" name="loanLimitAmount" id="loanLimitAmount" style="text-align:right;" maxlength="6" data-parsley-required="true">
                                    </div>
                                    <div class="col-sm-4">
                                        <select class="form-control" id="loanLimitUnit" name="loanLimitUnit" data-parsley-required="true">
                                            <option value="">Select Unit</option>
                                            <option value="Million">Million</option>
                                            <option value="Crore">Crore</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="remarks" class="col-sm-4 col-form-label">Remarks</label>
                                    <div class="col-sm-8">
                                        <textarea type="text" class="form-control" id="remarks" name="remarks" maxlength="300"></textarea>

                                    </div>
                                </div>

                            </div>

                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="agreementDate" class="col-sm-4 col-form-label">Agreement Date</label>
                                    <div class="col-sm-8">
                                        <input type="text" data-parsley-required="true" class="form-control" name="agreementDate" id="agreementDate">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="sendingDate" class="col-sm-4 col-form-label">Sending Date</label>
                                    <div class="col-sm-8">
                                        <input type="text" data-parsley-required="true" class="form-control" name="sendingDate" id="sendingDate">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="signingDate" class="col-sm-4 col-form-label">Signing Date</label>
                                    <div class="col-sm-8">
                                        <input type="text" data-parsley-required="true" class="form-control" name="signingDate" id="signingDate">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="expiredDate" class="col-sm-4 col-form-label">Expired Date</label>
                                    <div class="col-sm-8">
                                        <input type="text" data-parsley-required="true" class="form-control" name="expiredDate" id="expiredDate">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="expectedReportDate" class="col-sm-4 col-form-label">Expected Report Date</label>
                                    <div class="col-sm-8">
                                        <input type="text" data-parsley-required="true" class="form-control" name="expectedReportDate" id="expectedReportDate">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="priority" class="col-sm-4 col-form-label">Priority</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="priority" name="priority" data-parsley-required="true">
                                            <option value="High" selected="selected">High</option>
                                            <option value="Medium">Medium</option>
                                            <option value="Low">Low</option>
                                        </select>
                                    </div>
                                </div>




                            </div>
                        </div>
                        <br />
                        <div>
                            <label style="padding:0px 0px 0px 0px;font-size:18px;font-weight:600;color:black;" class="col-sm-10 pull-left">Fees Info</label>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="ratingYear" class="col-sm-4 col-form-label">Year</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="ratingYear" name="ratingYear">
                                            <option value="0">Select Year</option>
                                            @foreach (var data in Model.ratingYears)
                                            {
                                                <option value="@data.Id">@data.ratingYearName</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="agreementAmounts" class="col-sm-4 col-form-label">Agreement Amount</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control numeric" name="agreementAmounts" id="agreementAmounts" style="text-align:right;" maxlength="10">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="ratingAmounts" class="col-sm-4 col-form-label">Ratings Fees</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control numeric" name="ratingAmounts" id="ratingAmounts" style="text-align:right;" maxlength="10" readonly>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="vatPercent" class="col-sm-4 col-form-label">Vat(%)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control numeric" name="vatPercent" id="vatPercent" style="text-align:right;" maxlength="4" value="7.5">
                                    </div>
                                    <div class="col-sm-4">
                                        <select class="form-control" id="vatType" name="vatType">
                                            @foreach (var data in Model.vatCategories)
                                            {
                                                <option value="@data.Id">@data.vatCategoryName</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="taxRate" class="col-sm-4 col-form-label">Tax(%)</label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control numeric" name="taxRate" id="taxRate" style="text-align:right;" maxlength="4" value="7.5">
                                    </div>
                                    <div class="col-sm-4">
                                        <select class="form-control" id="taxType" name="taxType">
                                            @foreach (var data in Model.taxCategories)
                                            {
                                                <option value="@data.Id">@data.taxCategoryName</option>
                                            }

                                        </select>
                                    </div>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="rDate" class="col-sm-4 col-form-label">Rating Date</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" name="rDate" id="rDate">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="vatAmounts" class="col-sm-4 col-form-label">Vat Amount</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" name="vatAmounts" id="vatAmounts" style="text-align:right;" readonly>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="vatAmount" class="col-sm-4 col-form-label">Tax Amount</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" name="taxAmounts" id="taxAmounts" style="text-align:right;" readonly>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="totalAmount" class="col-sm-4 col-form-label">Total Amount</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" name="totalAmounts" id="totalAmounts" style="text-align:right;" readonly>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-md-12">
                                        <button type="button" onclick="AdditemDetails()" value="Add" title="Add" class="btn btn-success" style="float:right;"><i class="fas fa-plus fa-w-1"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br />
                        <div class="row">

                            <input type="hidden" id="detailsId" name="detailsId" value="0" />
                            <input type="hidden" id="IsEdit" name="IsEdit" value="0" />
                            <input type="hidden" id="isProposeds" name="isProposeds" value="0" />
                            <div class="col-12">
                                <table class="table table-bordered table-striped" id="tblitemDetails" data-parsley-required="true">
                                    <thead style="width:100%;background-color:lightgray;">
                                        <tr>
                                            <th style="width:12%">Rating Type</th>
                                            <th style="width:7%">Year</th>
                                            <th style="width:10%">Date</th>
                                            <th style="width:15%;text-align:right;">Agree. Amount</th>
                                            <th style="width:12%;text-align:right;">Rating Fees</th>
                                            <th style="width:12%;text-align:right;">Vat Amount</th>
                                            <th style="width:12%;text-align:right;">Tax Amount</th>
                                            <th style="width:12%;text-align:right;">Total Amount</th>
                                            <th style="width:10%">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <br />
                        <div>
                            <label style="padding:0px 0px 0px 0px;font-size:18px;font-weight:600;color:black;" class="col-sm-10 pull-left">Signatory/Witness</label>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="Company" class="col-sm-4 col-form-label"></label>
                                    <div class="col-sm-8">
                                        <label for="Company" class="col-sm-4 col-form-label">Company</label>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="companySignatory" class="col-sm-4 col-form-label">Signatory</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="companySignatory" name="companySignatory" data-parsley-required="true" data-parsley-trigger="keyup">
                                            <option value="">Select Signatory</option>
                                            @foreach (var data in Model.aspNetUsersViewModels)
                                            {
                                                <option value="@data.EmpName">@data.EmpName</option>
                                            }
                                        </select>

                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label for="companyWitness" class="col-sm-4 col-form-label">Witness</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="companyWitness" name="companyWitness" data-parsley-required="true" data-parsley-trigger="keyup">
                                            <option value="">Select Witness</option>
                                            @foreach (var data in Model.aspNetUsersViewModels)
                                            {
                                                <option value="@data.EmpName">@data.EmpName</option>
                                            }
                                        </select>

                                    </div>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label for="Company" class="col-sm-4 col-form-label"></label>
                                    <div class="col-sm-8">
                                        <label for="Company" class="col-sm-3 col-form-label">Lead</label>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="contactSignatoryId" class="col-sm-4 col-form-label">Signatory</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="contactSignatoryId" name="contactSignatoryId" data-parsley-required="true" data-parsley-trigger="keyup">
                                            <option value="">Select Signatory</option>
                                            @foreach (var data in Model.contacts)
                                            {
                                                <option value="@data.Id">@data.resource.resourceName</option>
                                            }
                                        </select>

                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label for="contactWitnessId" class="col-sm-4 col-form-label">Witness</label>
                                    <div class="col-sm-8">
                                        <select class="form-control" id="contactWitnessId" name="contactWitnessId" data-parsley-required="true" data-parsley-trigger="keyup">
                                            <option value="">Select Witness</option>
                                            @foreach (var data in Model.contacts)
                                            {
                                                <option value="@data.Id">@data.resource.resourceName</option>
                                            }
                                        </select>

                                    </div>
                                </div>

                            </div>
                        </div>



                        <button type="button" onclick="RefreshAll()" class="btn btn-danger btn-lg" style="float:right; margin-top:5px;margin-right:0px;"><i class="fas fa-sync"></i></button>&nbsp;&nbsp;
                        <button type="submit" value="Submit" class="btn btn-success btn-lg" style="float:right; margin-top:5px;margin-right: 10px;"><i class="fas fa-save"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script type="text/javascript">

        $(document).ready(function () {
            //$("#agreements").addClass("active");
            Common.Ajax('GET', '/global/api/GetLeadsByLeadOwner', [], 'json', ajaxGetLeadsByLeadOwner);

            $("#agreementDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#expiredDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#sendingDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#signingDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#rDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $("#expectedReportDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());
            $('#statusTable').DataTable();

            $(".numeric").keydown(function (e) {
                if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                    (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                    (e.keyCode >= 35 && e.keyCode <= 40)) {
                    return;
                }
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
            $("#agreementAmounts").keyup(function () {
                CalculateVat();
            });
            $("#vatPercent").keyup(function () {
                CalculateVat();
            });
            $("#vatType").change(function () {
                CalculateVat();
            });
            $("#taxRate").keyup(function () {
                CalculateVat();
            });
            $("#taxType").change(function () {
                CalculateVat();
            });

            if (@masterId>0) {
                Common.Ajax('GET', '/CRMLead/Agreement/GetAgreementByAgreementId/?AgreementId=' + @masterId, [], 'json', ajaxGetAgreementByAgreementId);
                Common.Ajax('GET', '/CRMLead/Agreement/GetAgreementDetailsbyAgreementId/?AgreementId=' + @masterId, [], 'json', ajaxGetAgreementDetailsbyAgreementId);


            }

    });
        function ajaxGetAgreementByAgreementId(response) {
            $("#agreementId").val(response.Id);
            $("#leadsId").val(response.leadsId);
            $("#leadName").val(response.leads.leadName);
            $("#agreementNo").val(response.agreementNo);
            $("#agreementTypeId").val(response.agreementTypeId);
            $("#agreementDate").val(getPurchaseDate(response.agreementDate.toString("dd-MMM-yyyy")));
            $("#expiredDate").val(getPurchaseDate(response.expiredDate.toString("dd-MMM-yyyy")));
            $("#sendingDate").val(getPurchaseDate(response.sendingDate.toString("dd-MMM-yyyy")));
            $("#signingDate").val(getPurchaseDate(response.signingDate.toString("dd-MMM-yyyy")));
            $("#expectedReportDate").val(getPurchaseDate(response.expectedReportDate.toString("dd-MMM-yyyy")));
            $("#agreementCategoryId").val(response.agreementCategoryId);
            $("#noOfReports").val(response.noOfReports);
            $("#loanLimitAmount").val(response.loanLimitAmount);
            $("#loanLimitUnit").val(response.loanLimitUnit);
            $("#priority").val(response.priority);
            $("#remarks").val(response.remarks);
            $("#companySignatory").val(response.companySignatory);
            $("#companyWitness").val(response.companyWitness);
            $("#contactSignatoryId").val(response.contactSignatoryId);
            $("#contactWitnessId").val(response.contactWitnessId);
            $("#agreementStatusId").val(response.agreementStatusId);
        }
    function ajaxGetAgreementDetailsbyAgreementId(response) {
            var ifExistIndex = window.localStorage.getItem("holdIndex1");
            var index = "0";
            if (ifExistIndex == "null" || ifExistIndex == null) {
                index = $("#tblitemDetails tbody>tr").length;
            }
            else {
                index = ifExistIndex;
                tdRID = $("#tblitemDetails tbody >tr:eq(" + ifExistIndex + ") td:eq(0) .clsId").val();
            }
            $("#tblitemDetails tbody>tr").empty();
            $.each(response, function (key, value) {
                index = $("#tblitemDetails tbody>tr").length;
                var dtTable = $("#tblitemDetails");
                var tableBody = dtTable.find('tbody');
                var trHtml = '<tr id=' + index + '>' +
                    '<td>' + value.ratingYear.ratingType + '<input type="hidden" name="id"class="clsId" value="' + value.Id + '"><input type="hidden" id="ratingYearId' + index + '" name="ratingYearId" class="clsratingYearId" value="' + value.ratingYearId + '"/><input type="hidden" id="isProposed' + index + '" name="isProposed" class="clsisProposed" value="' + value.isProposed + '"/></td>' +
                    '<td>' + value.ratingYear.ratingYearName + '<input type="hidden" id="vatCategoryId' + index + '" name="vatCategoryId" class="clsvatCategoryId" value="' + value.vatCategoryId + '"/><input type="hidden" id="taxCategoryId' + index + '" name="taxCategoryId" class="clstaxCategoryId" value="' + value.taxCategoryId + '"/></td>' +
                    '<td>' + value.ratingDate + '<input type="hidden" id="ratingDate' + index + '" name="ratingDate" class="clsratingDate" value="' + value.ratingDate + '"/></td>' +
                    '<td style="text-align:right;">' + value.agreementAmount + '<input type="hidden" id="agreementAmount' + index + '" name="agreementAmount" class="clsagreementAmount" value="' + value.agreementAmount + '"/></td>' +
                    '<td style="text-align:right;">' + value.ratingAmount + '<input type="hidden" id="ratingAmount' + index + '" name="ratingAmount" class="clsratingAmount" value="' + value.ratingAmount + '"/></td>' +
                    '<td style="text-align:right;">' + value.vatAmount + '<input type="hidden" id="vatAmount' + index + '" name="vatAmount" class="clsvatAmount" value="' + value.vatAmount + '"/></td>' +
                    '<td style="text-align:right;">' + value.taxAmount + '<input class="clstaxAmount" type="hidden" id="taxAmount' + index + '" name="taxAmount"  value="' + value.taxAmount + '"/></td>' +
                    '<td style="text-align:right;">' + value.totalAmount + '<input type="hidden" id="totalAmount' + index + '" name="totalAmount" class="clstotalAmount" value="' + value.totalAmount + '"/></td>' +
                    '<td><a href="javascript:void(0)"style="background-color:red;border-color:red" data-toggle="tooltip" title="Delete" class="btn btn-danger btn-xs" onclick="Delete(' + index + ')"><i class="fa fa-trash"></i></a>&nbsp;&nbsp;' +
                    '<a onclick="EditTbl(' + index + "," + value.ratingYearId + ", " + value.vatCategoryId + ",'" + value.ratingDate + "', " + value.taxCategoryId + "," + value.agreementAmount + "," + value.ratingAmount + "," + value.vatAmount + ", " + value.taxAmount + ", " + value.totalAmount + ", " + value.Id + ", " + value.isProposed + ')" href="javascript:void(0)" title="Edit" class="btn btn-success btn-xs" > <i class="fa fa-edit"></i></a >' +


                    '</tr>';

                if (ifExistIndex == null || ifExistIndex == "null") {

                    tableBody.append(trHtml);
                }
                else {
                    var rowUpdate = $("#tblitemDetails tbody >tr:eq(" + ifExistIndex + ")");
                    rowUpdate.replaceWith(trHtml);
                    window.localStorage.setItem("holdIndex1", null);
                    ifExistIndex = null;
                }
            })

            index = index + 1;

        }
        function ajaxGetLeadsByLeadOwner(response) {
            var GetInStockItemList = [];
            $.each(response, function (id, option) {
                var obj = new Object();
                obj.key = option.Id;
                obj.value = option.leadName;
                GetInStockItemList[GetInStockItemList.length] = obj;
            });
            $('#leadName').autocomplete({
                source: GetInStockItemList,
                select: function (event, ui) {
                    $("#leadsId").val(ui.item.key);
                    Common.Ajax('GET', '/CRMLead/Agreement/GetAllContactsByLeadsId/?LeadsId=' + ui.item.key, [], 'json', ajaxGetAllContactsByLeadsId);
                }
            });
    }
    function ajaxGetAllContactsByLeadsId(response) {
        $.each(response, function (key, value) {
            $('#contactSignatoryId').append('<option value="' + value.Id + '">' + value.resource.resourceName + '</option');
            $('#contactWitnessId').append('<option value="' + value.Id + '">' + value.resource.resourceName + '</option');
        });
    }
        function CalculateVat() {

            var vat = 0;
            var tax = 0;
            var totalAmount = 0;
            var netTotal = 0;
            var agreementAmount = 0;

            if ($("#agreementAmounts").val() != "") {
                agreementAmount = $("#agreementAmounts").val();
            }

            if ($("#vatType").val() =="1") {
                if ($("#vatPercent").val() != "" && $("#agreementAmounts").val() != "") {
                    var vatPercentage = $("#vatPercent").val();
                    var vatPercentageA = 100 + parseFloat(vatPercentage);
                    totalAmount = (parseFloat(agreementAmount) / vatPercentageA) * 100;
                    vat = parseFloat(agreementAmount) - parseFloat(totalAmount);
                    netTotal = parseFloat(totalAmount) + vat;
                }
            }
            if ($("#vatType").val() == "2") {
                if ($("#vatPercent").val() != "" && $("#agreementAmounts").val() != "") {
                    var vatPercentage = $("#vatPercent").val();
                    vat = agreementAmount * vatPercentage / 100;
                    totalAmount = parseFloat(agreementAmount);
                    netTotal = parseFloat(agreementAmount) + vat;
                }
            }
            if ($("#vatType").val() == "3") {
                if ($("#agreementAmounts").val() != "") {
                    vat = 0;
                    totalAmount = parseFloat(agreementAmount);
                    netTotal = parseFloat(agreementAmount);
                }
            }
            if ($("#taxType").val() == "1") {
                if ($("#vatPercent").val() != "" && $("#agreementAmounts").val() != "") {
                    var vatPercentage = $("#taxRate").val();
                    var vatPercentageA = 100 + parseFloat(vatPercentage);
                    totalAmount = (parseFloat(agreementAmount) / vatPercentageA) * 100;
                    tax = parseFloat(agreementAmount) - parseFloat(totalAmount);
                    netTotal = parseFloat(totalAmount) + tax;
                }
            }
            if ($("#taxType").val() == "2") {
                if ($("#taxRate").val() != "" && $("#agreementAmounts").val() != "") {
                    var vatPercentage = $("#taxRate").val();
                    tax = agreementAmount * vatPercentage / 100;
                    totalAmount = parseFloat(agreementAmount);
                    netTotal = parseFloat(agreementAmount) + tax;
                }
            }
            if ($("#taxType").val() == "3") {
                if ($("#agreementAmounts").val() != "") {
                    tax = 0;
                    totalAmount = parseFloat(agreementAmount);
                    netTotal = parseFloat(agreementAmount);
                }
            }
            if ($("#vatType").val() == "1" && $("#taxType").val() == "1") {
                totalAmount = parseFloat(agreementAmount) - vat - tax;
                netTotal = parseFloat(agreementAmount);
            }
            if ($("#vatType").val() == "2" && $("#taxType").val() == "2") {
                totalAmount = parseFloat(agreementAmount);
                netTotal =  parseFloat(agreementAmount) + vat + tax;
            }
            if ($("#vatType").val() == "3" && $("#taxType").val() == "3") {
                totalAmount = parseFloat(agreementAmount);
                netTotal = parseFloat(agreementAmount) ;
            }

            if ($("#vatType").val() == "2" && $("#taxType").val() == "3") {
                totalAmount = parseFloat(agreementAmount);
                netTotal = parseFloat(agreementAmount) + vat + tax;
            }

            $("#vatAmounts").val(vat.toFixed(2));
            $("#taxAmounts").val(tax.toFixed(2));
            $("#ratingAmounts").val(totalAmount.toFixed(2));
            $("#totalAmounts").val(netTotal.toFixed(2));
        }

        function getPurchaseDate(pdate) {
            var formattedDate = new Date(pdate);
            var d = formattedDate.getDate();
            var m = formattedDate.getMonth();
            var y = formattedDate.getFullYear();
            var monthNames = [
                "Jan", "Feb", "Mar",
                "Apr", "May", "Jun", "Jul",
                "Aug", "Sep", "Oct",
                "Nov", "Dec"
            ];
            var fullDate = d + "-" + monthNames[m] + "-" + y;
            return fullDate;
        }


        function RefreshAll() {
            location.reload();
        }
        function AdditemDetails() {

            var ifExistIndex = window.localStorage.getItem("holdIndex1");

            var index = "0";
            if (ifExistIndex == "null" || ifExistIndex == null) {
                index = $("#tblitemDetails tbody>tr").length;
            }
            else {
                index = ifExistIndex;
                tdRID = $("#tblitemDetails tbody >tr:eq(" + ifExistIndex + ") td:eq(0) .clsId").val();
            }

            if ($("#ratingYear").val() == "0") {
                alert("Plaese Select Year.");
                return false
            }
            if ($("#agreementAmounts").val() == "") {
                alert("Plaese Enter Agreement Amount.");
                return false
            }
            if ($("#totalAmounts").val() == "") {
                alert("Plaese Enter Agreement Amount.");
                return false
            }
            var ratingType = "Surveillance";
            if ($("#ratingYear").val() == "1") {
                ratingType = "Initial";
            }
            var taxAmount = 0;
            var vatAmount = 0;
            let Id = parseInt($("#detailsId").val()) ? parseInt($("#detailsId").val()) : 0;
            var ratingYearId = $("#ratingYear").val();
            var ratingYearName = $("#ratingYear option:selected").text();
            var ratingDate = $("#rDate").val();
            var agreementAmount = $("#agreementAmounts").val();
            var ratingAmount = $("#ratingAmounts").val();
            var vatCategoryId = $("#vatType").val();
            var taxCategoryId = $("#taxType").val();
            var isProposed = $("#isProposeds").val();
            if ($("#vatAmounts").val() != "") {
                vatAmount = parseFloat($("#vatAmounts").val());
            }
            if ($("#taxAmounts").val() != "") {
                taxAmount = parseFloat($("#taxAmounts").val());
            }
            var totalAmount = parseFloat($("#totalAmounts").val());

            var RowCount = $("#tblitemDetails tbody>tr").length;
            var editOption = parseInt($('#IsEdit').val()) ? parseInt($('#IsEdit').val()) : 0;

            for (i = 0; i < RowCount; i++) {
                var _ratingYearId = $("#ratingYearId" + i).val();

                if (_ratingYearId == ratingYearId && editOption == 0) {
                    alert('You have already added this Year!');
                    return false
                }
            }

            var dtTable = $("#tblitemDetails");
            var tableBody = dtTable.find('tbody');
            var trHtml = '<tr id=' + index + '>' +
                '<td>' + ratingType + '<input type="hidden" name="id"class="clsId" value="' + Id + '"><input type="hidden" id="ratingYearId' + index + '" name="ratingYearId" class="clsratingYearId" value="' + ratingYearId + '"/><input type="hidden" id="isProposed' + index + '" name="isProposed" class="clsisProposed" value="' + isProposed + '"/></td>' +
                '<td>' + ratingYearName + '<input type="hidden" id="vatCategoryId' + index + '" name="vatCategoryId" class="clsvatCategoryId" value="' + vatCategoryId + '"/><input type="hidden" id="taxCategoryId' + index + '" name="taxCategoryId" class="clstaxCategoryId" value="' + taxCategoryId + '"/></td>' +
                '<td>' + ratingDate + '<input type="hidden" id="ratingDate' + index + '" name="ratingDate" class="clsratingDate" value="' + ratingDate + '"/></td>' +
                '<td style="text-align:right;">' + agreementAmount + '<input type="hidden" id="agreementAmount' + index + '" name="agreementAmount" class="clsagreementAmount" value="' + agreementAmount + '"/></td>' +
                '<td style="text-align:right;">' + ratingAmount + '<input type="hidden" id="ratingAmount' + index + '" name="ratingAmount" class="clsratingAmount" value="' + ratingAmount + '"/></td>' +
                '<td style="text-align:right;">' + vatAmount + '<input type="hidden" id="vatAmount' + index + '" name="vatAmount" class="clsvatAmount" value="' + vatAmount + '"/></td>' +
                '<td style="text-align:right;">' + taxAmount + '<input class="clstaxAmount" type="hidden" id="taxAmount' + index + '" name="taxAmount"  value="' + taxAmount + '"/></td>' +
                '<td style="text-align:right;">' + totalAmount + '<input type="hidden" id="totalAmount' + index + '" name="totalAmount" class="clstotalAmount" value="' + totalAmount + '"/></td>' +
                '<td><a href="javascript:void(0)"style="background-color:red;border-color:red" data-toggle="tooltip" title="Delete" class="btn btn-danger btn-xs" onclick="Delete(' + index + ')"><i class="fa fa-trash"></i></a>&nbsp;&nbsp;' +
                '<a onclick="EditTbl(' + index + "," + ratingYearId + ", " + vatCategoryId + ",'" + ratingDate + "', " + taxCategoryId + "," + agreementAmount + "," + ratingAmount + "," + vatAmount + ", " + taxAmount + ", " + totalAmount + ", " + Id + ", " + isProposed+ ')" href="javascript:void(0)" title="Edit" class="btn btn-success btn-xs" > <i class="fa fa-edit"></i></a >' +

                '</tr>';

            if (ifExistIndex == null || ifExistIndex == "null") {
                tableBody.append(trHtml);
            }
            else {
                var rowUpdate = $("#tblitemDetails tbody >tr:eq(" + ifExistIndex + ")");
                rowUpdate.replaceWith(trHtml);
                window.localStorage.setItem("holdIndex", null);
                ifExistIndex = null;
            }
            Refresh();
        }

    function EditTbl(index, ratingYearId, vatCategoryId, ratingDate, taxCategoryId, agreementAmount, ratingAmount, vatAmount, taxAmount, totalAmount, Id, isProposed) {

            var rightIndex = index;
            $("#IsEdit").val(1);
            $('#detailsId').val(Id);
            $('#ratingYear').val(ratingYearId);
            $('#vatType').val(vatCategoryId);
            $("#rDate").val(getPurchaseDate(ratingDate.toString("dd-MMM-yyyy")));
            $('#taxType').val(taxCategoryId);
            $('#agreementAmounts').val(agreementAmount);
            $('#ratingAmounts').val(ratingAmount);
            $('#vatAmounts').val(vatAmount);
            $('#taxAmounts').val(taxAmount);
            $('#totalAmounts').val(totalAmount);
            $('#isProposeds').val(isProposed);

            window.localStorage.setItem('holdIndex1', null);
            if (rightIndex != null) {
                window.localStorage.setItem('holdIndex1', rightIndex);
            }
        }

        function Refresh() {
            $('#detailsId').val('');
            $("#IsEdit").val(0);
            $("#isProposed").val(0);

            $('#ratingYearId').val('0');
            $('#vatType').val('3');
            $('#taxType').val('3');
            $('#agreementAmounts').val('');
            $('#ratingAmounts').val('');
            $('#vatAmounts').val('');
            $('#taxAmounts').val('');
            $('#totalAmounts').val('');
            $("#rDate").datepicker({ dateFormat: "dd-M-yy", showAnim: "scale", changeMonth: true, changeYear: true, yearRange: "2010:2030" }).datepicker("setDate", new Date());

            window.localStorage.setItem("holdIndex1", null);
            ifExistIndex = null;
        }

        function Delete(index) {
            swal({
                title: 'Are you sure?', text: 'Do you want to delete this record!', type: 'warning', showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Yes, delete it!'
            }).then(function () {
                $("#tblitemDetails #" + index).remove();
                swal('', 'Deleted Successfully!', 'success');

            });
        }


    </script>
}


@section Style{
    <style>

        .redStar {
            color: red;
        }

        #statusTable tbody tr {
            cursor: pointer;
        }
    </style>
}







